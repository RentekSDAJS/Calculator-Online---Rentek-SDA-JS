<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDA Data Hub - Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #d4af37; --green: #10b981; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; display: none; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; background: #f8fafc; padding: 20px; border-radius: 15px; border: 1px solid #e2e8f0; }
        input, select { padding: 12px; border: 2px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; }
        .btn-save { background: var(--navy); color: var(--gold); padding: 15px; border-radius: 10px; width: 100%; margin-top: 15px; font-weight: 800; cursor: pointer; border: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--navy); color: var(--gold); padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        #authOverlay { position: fixed; inset: 0; background: var(--navy); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        #loading { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading"><h3>Sedang Menyimpan ke GitHub... ‚è≥</h3></div>

<div id="authOverlay">
    <div style="background:white; padding:40px; border-radius:24px; text-align:center; width:350px;">
        <h2 style="color:var(--navy);">SDA Admin Hub</h2>
        <p style="font-size:0.8rem; color:#64748b;">Masukan Password & Token GitHub</p>
        <input type="password" id="passCode" placeholder="Password: admin123" style="width:100%; margin-bottom:10px; text-align:center;">
        <input type="password" id="gitToken" placeholder="GitHub Token: ghp_xxxx" style="width:100%; text-align:center;">
        <button onclick="login()" style="background:var(--navy); color:var(--gold); padding:12px; width:100%; border-radius:8px; margin-top:15px; font-weight:bold; border:none; cursor:pointer;">MASUK</button>
    </div>
</div>

<div class="container" id="mainApp">
    <div class="card">
        <h2>‚ûï Input Data Hujan</h2>
        <div class="form-grid">
            <div><label>Tahun</label><br><input type="number" id="inYear" style="width:100%"></div>
            <div><label>Stasiun</label><br><select id="inStation" style="width:100%"></select></div>
            <div><label>Nilai (mm)</label><br><input type="number" step="0.1" id="inValue" style="width:100%"></div>
        </div>
        <button class="btn-save" onclick="updateData()">SIMPAN KE DATABASE GITHUB</button>
    </div>

    <div class="card">
        <div style="display:flex; justify-content:space-between;">
            <h2>üìä Daftar Rekap</h2>
            <select id="viewStation" onchange="renderTable()"></select>
        </div>
        <table id="rainTable">
            <thead><tr><th>TAHUN</th><th>NILAI (mm)</th><th>STATUS</th></tr></thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const CONFIG = { owner: 'RentekSDAJS', repo: 'Calculator-Online---Rentek-SDA-JS', path: 'data/hujan/all-data.json' };
    let allData = [], sha = '';
    const stasiunList = ["Kemayoran", "Halim", "Bogor", "Banten", "Katulampa", "Depok", "Manggarai", "Karet", "Setiabudi Timur", "Melati", "Istana", "Krukut Hulu", "Sunter Hulu", "Pesanggrahan", "Angke Hulu", "Tanjungan", "Tomang Barat", "Teluk Gong", "Pulo Gadung", "Sunter Kodamar", "Sunter III Rawa Badak", "Pompa Cideng"];

    function login() {
        const pass = document.getElementById('passCode').value;
        const token = document.getElementById('gitToken').value;
        if(pass === "admin123" && token.startsWith('ghp_')) {
            localStorage.setItem('gh_token', token);
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            fetchGitHubData();
        } else { alert("Cek Password atau Token ghp_ Anda!"); }
    }

    async function fetchGitHubData() {
        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
        const r = await fetch(url, { headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}` }});
        const j = await r.json();
        sha = j.sha;
        allData = JSON.parse(atob(j.content));
        
        const inS = document.getElementById('inStation'), viewS = document.getElementById('viewStation');
        stasiunList.forEach((s, i) => {
            let val = `st_${(i+1).toString().padStart(2,'0')}`;
            inS.innerHTML += `<option value="${val}">${s}</option>`;
            viewS.innerHTML += `<option value="${val}">${s}</option>`;
        });
        renderTable();
    }

    function renderTable() {
        const key = document.getElementById('viewStation').value;
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        allData.sort((a,b) => a.tahun - b.tahun); // URUTAN TERLAMA
        allData.forEach(d => {
            tbody.innerHTML += `<tr><td><strong>${d.tahun}</strong></td><td>${d[key] || 0} mm</td><td style="color:green">‚úÖ Terverifikasi</td></tr>`;
        });
    }

    async function updateData() {
        const yr = parseInt(document.getElementById('inYear').value);
        const st = document.getElementById('inStation').value;
        const val = parseFloat(document.getElementById('inValue').value);
        if(!yr || isNaN(val)) return alert("Isi lengkap!");
        
        document.getElementById('loading').style.display = 'flex';
        let entry = allData.find(d => d.tahun === yr);
        if(entry) entry[st] = val; 
        else { let n = { tahun: yr }; n[st] = val; allData.push(n); }

        const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
        const body = { message: `Update data ${yr}`, content: btoa(JSON.stringify(allData, null, 2)), sha: sha };
        const res = await fetch(url, {
            method: 'PUT',
            headers: { 'Authorization': `token ${localStorage.getItem('gh_token')}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        if(res.ok) { alert("‚úÖ BERHASIL DISIMPAN!"); location.reload(); }
        else { alert("Gagal Simpan!"); document.getElementById('loading').style.display = 'none'; }
    }
</script>
</body>
</html>
