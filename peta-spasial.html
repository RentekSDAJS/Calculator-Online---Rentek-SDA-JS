<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Spatial Analyzer FIX</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #0f172a; }
        #sidebar { width: 350px; background: #1e293b; color: white; padding: 20px; z-index: 1000; overflow-y: auto; border-right: 4px solid #f59e0b; }
        #map { flex: 1; }
        .card { background: #0f172a; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #334155; }
        .btn { background: #f59e0b; color: #000; padding: 10px; border-radius: 5px; cursor: pointer; display: block; text-align: center; font-weight: bold; text-decoration: none; }
        #result { background: #0369a1; padding: 15px; border-radius: 10px; display: none; margin-top: 15px; border-left: 5px solid #f59e0b; }
        .st-item { background: #334155; padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; }
        h2 { color: #f59e0b; margin-top: 0; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>SDA JAKSEL</h2>
    <p style="font-size: 0.8rem; opacity: 0.7;">Thiessen Polygon Analyzer</p>
    
    <div class="card">
        <label style="font-size: 0.85rem;">Upload File (watershed.json):</label><br><br>
        <input type="file" id="fileInput" accept=".json,.geojson" style="display:none">
        <a class="btn" onclick="document.getElementById('fileInput').click()">PILIH FILE</a>
        <div id="status" style="font-size: 0.7rem; margin-top:10px; color:#94a3b8">Status: Menunggu file...</div>
    </div>

    <div id="result">
        <span style="font-size: 0.7rem; font-weight: bold;">RERATA HUJAN:</span>
        <div id="valHujan" style="font-size: 2rem; font-weight: bold;">0 mm</div>
    </div>

    <div id="listStasiun" style="margin-top:20px"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
    // 1. Koordinat Stasiun (Data Master)
    const STASIUN = [
        { nama: "Katulampa", lat: -6.6331, lng: 106.8370, hujan: 25 },
        { nama: "Depok", lat: -6.4006, lng: 106.8318, hujan: 10 },
        { nama: "Manggarai", lat: -6.2074, lng: 106.8485, hujan: 5 },
        { nama: "Pesanggrahan", lat: -6.3970, lng: 106.7718, hujan: 40 },
        { nama: "Sunter Hulu", lat: -6.3178, lng: 106.9211, hujan: 20 },
        { nama: "Krukut Hulu", lat: -6.3443, lng: 106.7990, hujan: 30 },
        { nama: "Halim", lat: -6.2703, lng: 106.8892, hujan: 22 }
    ];

    // Setup Proyeksi UTM 48S ke WGS84
    const utmProj = "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs";
    const wgsProj = "+proj=longlat +datum=WGS84 +no_defs";

    // Inisialisasi Peta
    const map = L.map('map').setView([-6.28, 106.81], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const layerGroup = L.layerGroup().addTo(map);

    // Marker Stasiun
    const pts = STASIUN.map(s => {
        L.circleMarker([s.lat, s.lng], {radius: 5, color: 'red', fillOpacity: 1}).addTo(map).bindPopup(s.nama);
        return turf.point([s.lng, s.lat], s);
    });

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                let data = JSON.parse(ev.target.result);
                processData(data);
                document.getElementById('status').innerText = "✅ Berhasil memuat: " + file.name;
            } catch(err) {
                document.getElementById('status').innerText = "❌ Gagal: " + err.message;
            }
        };
        reader.readAsText(file);
    };

    function processData(raw) {
        layerGroup.clearLayers();
        
        // 2. PARSING KHUSUS GEOMETRYCOLLECTION & UTM
        let polygonWGS;
        try {
            // Ambil geometri pertama dari collection
            let geom = raw.geometries ? raw.geometries[0] : (raw.features ? raw.features[0].geometry : raw);
            
            // Konversi koordinat dari UTM ke Desimal
            let newCoords = geom.coordinates.map(ring => 
                ring.map(c => {
                    let p = proj4(utmProj, wgsProj, [c[0], c[1]]);
                    return [p[0], p[1]];
                })
            );
            
            polygonWGS = turf.polygon(newCoords);
        } catch(e) {
            alert("Format koordinat file tidak dikenali!");
            return;
        }

        // Tampilkan Area
        L.geoJSON(polygonWGS, {style: {color: '#38bdf8', weight: 3, fillOpacity: 0.1}}).addTo(layerGroup);
        map.fitBounds(L.geoJSON(polygonWGS).getBounds());

        // 3. THIESSEN ANALYSIS
        const bbox = turf.bbox(polygonWGS);
        const voronoi = turf.voronoi(turf.featureCollection(pts), {
            bbox: [bbox[0]-0.1, bbox[1]-0.1, bbox[2]+0.1, bbox[3]+0.1]
        });

        let totalWxA = 0, totalA = 0;
        const listUI = document.getElementById('listStasiun');
        listUI.innerHTML = "";

        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, polygonWGS);
            if (clip) {
                const area = turf.area(clip) / 10000; // Ha
                const st = STASIUN[i];
                totalWxA += (st.hujan * area);
                totalA += area;

                L.geoJSON(clip, {style: {color: 'orange', weight: 1.5, fillOpacity: 0.3}}).addTo(layerGroup);
                listUI.innerHTML += `<div class="st-item"><b>${st.nama}</b><br>Hujan: ${st.hujan} mm | Luas: ${area.toFixed(2)} Ha</div>`;
            }
        });

        if (totalA > 0) {
            document.getElementById('result').style.display = 'block';
            document.getElementById('valHujan').innerText = (totalWxA / totalA).toFixed(2) + " mm";
        }
    }
</script>

</body>
</html>
