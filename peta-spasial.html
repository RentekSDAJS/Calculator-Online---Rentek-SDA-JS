<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Peta Spasial (Auto-Fix)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #sidebar { width: 360px; background: #0f172a; color: white; padding: 25px; z-index: 1000; overflow-y: auto; }
        #map { flex: 1; background: #cbd5e1; }
        .upload-box { background: #1e293b; padding: 15px; border-radius: 10px; border: 2px dashed #334155; margin: 20px 0; }
        #hasil-rerata { background: #075985; padding: 15px; border-radius: 10px; margin-top: 20px; display: none; border-left: 6px solid #f59e0b; }
        .st-card { background: #334155; padding: 10px; border-radius: 6px; margin-bottom: 8px; font-size: 0.8rem; border-left: 3px solid #f59e0b; }
        h2 { color: #f59e0b; font-size: 1.3rem; margin: 0; }
        .error-msg { color: #f87171; font-size: 0.8rem; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>PETA SPASIAL</h2>
    <p style="font-size: 0.75rem; opacity: 0.7;">Seksi Perencanaan SDA Jakarta Selatan</p>
    <hr style="border: 0.5px solid #334155;">

    <div class="upload-box">
        <label style="font-size: 0.9rem; font-weight: bold;">Upload GeoJSON:</label><br><br>
        <input type="file" id="input-geojson" accept=".geojson" style="font-size: 0.8rem; color: white;">
        <div id="error-display" class="error-msg"></div>
    </div>

    <div id="hasil-rerata">
        <span style="font-size: 0.75rem;">CURAH HUJAN WILAYAH:</span>
        <div id="text-hujan" style="font-size: 2.2rem; font-weight: 800; color: #facc15;">0 mm</div>
    </div>

    <h3 style="font-size: 0.9rem; margin-top: 25px;">Stasiun Terdeteksi:</h3>
    <div id="stasiun-list"></div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

<script>
    // Database Master (Koordinat & Angka Hujan)
    const DATA_MASTER = [
        { n: "Katulampa", lat: -6.6331, lng: 106.8370, h: 25 },
        { n: "Depok", lat: -6.4006, lng: 106.8318, h: 10 },
        { n: "Manggarai", lat: -6.2074, lng: 106.8485, h: 5 },
        { n: "Karet", lat: -6.1981, lng: 106.8100, h: 12 },
        { n: "Istana", lat: -6.1716, lng: 106.8270, h: 8 },
        { n: "Pesanggrahan", lat: -6.3970, lng: 106.7718, h: 18 },
        { n: "Sunter Hulu", lat: -6.3178, lng: 106.9211, h: 20 },
        { n: "Krukut Hulu", lat: -6.3443, lng: 106.7990, h: 30 },
        { n: "Halim", lat: -6.2703, lng: 106.8892, h: 22 },
        { n: "Banten", lat: -6.2615, lng: 106.7508, h: 15 },
        { n: "Bogor", lat: -6.5000, lng: 106.7500, h: 45 }
    ];

    const UTM_48S = "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs";
    const WGS84 = "+proj=longlat +datum=WGS84 +no_defs";

    let map = L.map('map').setView([-6.28, 106.81], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let analysisGroup = L.layerGroup().addTo(map);

    // Titik Stasiun
    const ptsTurf = DATA_MASTER.map(d => {
        L.circleMarker([d.lat, d.lng], {radius: 5, color: 'red', fillOpacity: 1}).addTo(map).bindPopup(d.n);
        return turf.point([d.lng, d.lat], d);
    });

    document.getElementById('input-geojson').onchange = function(e) {
        const reader = new FileReader();
        const errDiv = document.getElementById('error-display');
        errDiv.style.display = 'none';

        reader.onload = function(event) {
            try {
                let geojson = JSON.parse(event.target.result);
                prosesAnalisis(geojson);
            } catch(err) {
                errDiv.innerText = "Error: File bukan JSON/GeoJSON yang valid!";
                errDiv.style.display = 'block';
            }
        };
        reader.readAsText(e.target.files[0]);
    };

    function prosesAnalisis(data) {
        analysisGroup.clearLayers();
        
        // 1. Normalisasi: Pastikan format GeoJSON lengkap (FeatureCollection)
        let fc = data.type === "FeatureCollection" ? data : turf.featureCollection([data.type === "Feature" ? data : turf.feature(data)]);
        
        // 2. Cek Proyeksi: Jika koordinat > 1000, berarti UTM, konversi ke WGS84
        fc = turf.clone(fc);
        turf.featureEach(fc, function(currentFeature) {
            let coords = turf.getCoords(currentFeature);
            // Cek di level koordinat pertama
            let testVal = Array.isArray(coords[0]) ? (Array.isArray(coords[0][0]) ? coords[0][0][0] : coords[0][0]) : coords[0];
            
            if (Math.abs(testVal) > 1000) {
                console.log("Mendeteksi UTM, Mengonversi...");
                currentFeature.geometry.coordinates = transformCoords(currentFeature.geometry.coordinates);
            }
        });

        // 3. Gambar di Peta
        let mainLayer = L.geoJSON(fc, { style: { color: '#38bdf8', weight: 3, fillOpacity: 0.1 } }).addTo(analysisGroup);
        map.fitBounds(mainLayer.getBounds());

        // 4. Analisis Thiessen
        let poly = fc.features[0];
        let bbox = turf.bbox(poly);
        const voronoi = turf.voronoi(turf.featureCollection(ptsTurf), { 
            bbox: [bbox[0]-0.5, bbox[1]-0.5, bbox[2]+0.5, bbox[3]+0.5] 
        });

        let totalWxA = 0, totalA = 0;
        const listHTML = document.getElementById('stasiun-list');
        listHTML.innerHTML = "";

        voronoi.features.forEach((v, i) => {
            const intersect = turf.intersect(v, poly);
            if (intersect) {
                const area = turf.area(intersect) / 10000; // Ha
                const st = ptsTurf[i].properties;
                totalWxA += (st.h * area);
                totalA += area;

                L.geoJSON(intersect, { style: { color: 'orange', weight: 1, fillOpacity: 0.4 } }).addTo(analysisGroup);
                listHTML.innerHTML += `<div class="st-card"><b>${st.n}</b><br>Hujan: ${st.h} mm | Luas: ${area.toFixed(2)} Ha</div>`;
            }
        });

        if (totalA > 0) {
            document.getElementById('hasil-rerata').style.display = 'block';
            document.getElementById('text-hujan').innerText = (totalWxA / totalA).toFixed(2) + " mm";
        }
    }

    // Fungsi Pembantu Konversi UTM ke WGS84 secara mendalam
    function transformCoords(coords) {
        if (typeof coords[0] === 'number') {
            let p = proj4(UTM_48S, WGS84, [coords[0], coords[1]]);
            return [p[0], p[1]];
        }
        return coords.map(transformCoords);
    }
</script>
</body>
</html>
