<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Spatial Analyzer REPAIR</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 350px; background: #1a202c; color: white; padding: 20px; z-index: 1000; box-shadow: 2px 0 5px rgba(0,0,0,0.3); }
        #map { flex: 1; background: #e5e7eb; }
        .upload-box { background: #2d3748; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px dashed #4a5568; }
        .hasil-box { background: #ebf8ff; color: #2c5282; padding: 15px; border-radius: 8px; margin-top: 20px; display: none; }
        .st-item { background: #4a5568; padding: 10px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="color: #ecc94b;">SPATIAL ANALYZER</h2>
    <p style="font-size: 0.8rem; opacity: 0.7;">Sudin SDA Jakarta Selatan</p>
    <hr>
    
    <div class="upload-box">
        <label>1. Upload GeoJSON Area:</label><br><br>
        <input type="file" id="input-file" accept=".geojson">
    </div>

    <div id="hasil-box" class="hasil-box">
        <strong>HASIL RERATA HUJAN:</strong>
        <div id="rerata-text" style="font-size: 2rem; font-weight: bold;">0 mm</div>
    </div>

    <h3>Stasiun Terdeteksi:</h3>
    <div id="stasiun-list" style="max-height: 300px; overflow-y: auto;">
        <p style="font-size: 0.8rem; opacity: 0.5;">Belum ada analisis...</p>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    // DATA STASIUN LANGSUNG DI SINI (DATABASE INTERNAL)
    const DATA_HUJAN = [
        { n: "Katulampa", lat: -6.6331, lng: 106.8370, h: 20 },
        { n: "Depok", lat: -6.4006, lng: 106.8318, h: 15 },
        { n: "Manggarai", lat: -6.2074, lng: 106.8485, h: 10 },
        { n: "Karet", lat: -6.1981, lng: 106.8100, h: 5 },
        { n: "Istana", lat: -6.1716, lng: 106.8270, h: 12 },
        { n: "Pesanggrahan", lat: -6.3970, lng: 106.7718, h: 25 },
        { n: "Sunter Hulu", lat: -6.3178, lng: 106.9211, h: 18 },
        { n: "Krukut Hulu", lat: -6.3443, lng: 106.7990, h: 22 },
        { n: "Halim", lat: -6.2703, lng: 106.8892, h: 30 },
        { n: "Banten", lat: -6.2615, lng: 106.7508, h: 15 },
        { n: "Bogor", lat: -6.5000, lng: 106.7500, h: 40 }
    ];

    // 1. Munculkan Peta Duluan (Biar Gak Blank)
    const map = L.map('map').setView([-6.28, 106.81], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const layerAnalisis = L.layerGroup().addTo(map);

    // 2. Gambar titik merah stasiun
    const ptsTurf = DATA_HUJAN.map(d => {
        L.circleMarker([d.lat, d.lng], {radius: 5, color: 'red', fillOpacity: 1}).addTo(map).bindPopup(d.n);
        return turf.point([d.lng, d.lat], d);
    });

    // 3. Proses File GeoJSON
    document.getElementById('input-file').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const geojson = JSON.parse(event.target.result);
                prosesAnalisis(geojson);
            } catch(err) {
                alert("File bukan GeoJSON yang benar!");
            }
        };
        reader.readAsText(e.target.files[0]);
    };

    function prosesAnalisis(data) {
        layerAnalisis.clearLayers();
        const polyLayer = L.geoJSON(data, { style: { color: 'blue', fillOpacity: 0.1 } }).addTo(layerAnalisis);
        map.fitBounds(polyLayer.getBounds());

        let poly = data.features ? data.features[0] : data;
        let bbox = turf.bbox(poly);
        
        // Buat Voronoi (Thiessen)
        const voronoi = turf.voronoi(turf.featureCollection(ptsTurf), { 
            bbox: [bbox[0]-0.5, bbox[1]-0.5, bbox[2]+0.5, bbox[3]+0.5] 
        });

        let totalHujanKaliLuas = 0;
        let totalLuas = 0;
        const listHTML = document.getElementById('stasiun-list');
        listHTML.innerHTML = "";

        voronoi.features.forEach((v, i) => {
            const potong = turf.intersect(v, poly);
            if (potong) {
                const luas = turf.area(potong) / 10000; // Hektar
                const st = ptsTurf[i].properties;

                totalHujanKaliLuas += (st.h * luas);
                totalLuas += luas;

                L.geoJSON(potong, { style: { color: 'orange', weight: 1 } }).addTo(layerAnalisis);
                
                listHTML.innerHTML += `<div class="st-item"><b>${st.n}</b><br>Hujan: ${st.h} mm | Luas: ${luas.toFixed(2)} Ha</div>`;
            }
        });

        if (totalLuas > 0) {
            const hasil = totalHujanKaliLuas / totalLuas;
            document.getElementById('hasil-box').style.display = 'block';
            document.getElementById('rerata-text').innerText = hasil.toFixed(2) + " mm";
        }
    }
</script>

</body>
</html>
