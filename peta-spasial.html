<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS ULTIMATE | ANALISIS & MONITORING</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; --green: #059669; --red: #dc2626; --blue: #2563eb; --cyan: #06b6d4; --indigo: #6366f1; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        #map { flex: 2; z-index: 1; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 10px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; font-size: 12px; }
        .upload-btn.saluran { background: var(--indigo); margin-top: 5px; }
        h2 { margin-top: 0; color: var(--main); font-size: 1.4rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        h3 { font-size: 10px; text-transform: uppercase; color: #64748b; margin: 0 0 10px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 5px; }
        th { background: #f1f5f9; color: #475569; padding: 8px; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .tfoot-bold { background: #f1f5f9; font-weight: bold; color: var(--main); }
        .station-label { background: rgba(255, 255, 255, 0.9) !important; border: 1px solid #1e293b !important; border-radius: 3px !important; padding: 1px 4px !important; font-weight: 800 !important; color: #1e293b !important; font-size: 11px !important; box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .color-box { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2>HYDRO-SPATIAL ULTIMATE</h2>
    <div id="dbStatus"></div>

    <div class="card">
        <h3>1. Input Data Spasial</h3>
        <button class="upload-btn" onclick="document.getElementById('fDAS').click()">UPLOAD AREA DAS (GEOJSON)</button>
        <input type="file" id="fDAS" style="display:none" accept=".json,.geojson">
        
        <button class="upload-btn saluran" onclick="document.getElementById('fSaluran').click()">UPLOAD DATA SALURAN (GEOJSON)</button>
        <input type="file" id="fSaluran" style="display:none" accept=".json,.geojson" multiple>
    </div>

    <div id="resThiessen" class="card" style="display:none">
        <h3>2. Koefisien Thiessen & Warna DAS</h3>
        <table>
            <thead><tr><th style="text-align:left">Stasiun</th><th>Luas (km²)</th><th>Bobot (W)</th></tr></thead>
            <tbody id="tBody"></tbody>
            <tfoot id="tFoot"></tfoot>
        </table>
    </div>

    <div id="resYearly" class="card" style="display:none">
        <h3>3. Tren Hujan Rerata Wilayah</h3>
        <canvas id="rainChart"></canvas>
    </div>

    <div id="resFreq" class="card" style="display:none">
        <h3>5. Analisis Frekuensi (LP-III)</h3>
        <table id="fTable">
            <thead><tr><th>T (Th)</th><th>Hujan Rencana (mm)</th></tr></thead>
            <tbody id="fBody"></tbody>
        </table>
        <div id="bestMethod"></div>
    </div>
</div>

<script>
    // Inisialisasi Peta
    const map = L.map('map').setView([-6.20, 106.84], 12);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    let analysisLayer = L.layerGroup().addTo(map);
    let stMarkers = L.layerGroup().addTo(map);
    let layerPhb = L.layerGroup().addTo(map);
    let layerMikro = L.layerGroup().addTo(map);
    let rainChart = null;

    L.control.layers({ "Peta": osm }, { 
        "Stasiun Hujan": stMarkers,
        "Analisis DAS": analysisLayer,
        "Saluran Phb": layerPhb,
        "Saluran Mikro": layerMikro 
    }, { collapsed: false }).addTo(map);

    // Database Status (Simulasi data sebelumnya)
    let currentDB = JSON.parse(localStorage.getItem('sda_db_final_clean')) || null;
    function refreshDatabase() {
        if (!currentDB) return;
        stMarkers.clearLayers();
        Object.keys(currentDB).forEach(id => {
            const st = currentDB[id];
            const marker = L.circleMarker([st.lat, st.lng], { radius: 7, color: '#1e293b', fillColor: '#f59e0b', fillOpacity: 1, weight: 2 });
            marker.bindPopup(`<strong>${st.n}</strong><br>Lat: ${st.lat}<br>Long: ${st.lng}`);
            marker.addTo(stMarkers);
        });
    }
    refreshDatabase();

    // LOGIKA ARAH ALIRAN (Flow Direction)
    function getArrowStyle(color) {
        return {
            color: color,
            weight: 3,
            opacity: 0.8,
            dashArray: '10, 10', // Membuat garis putus-putus
            lineCap: 'round'
        };
    }

    // Fungsi untuk memproses GeoJSON Saluran
    document.getElementById('fSaluran').onchange = (e) => {
        const files = e.target.files;
        for(let file of files) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const data = JSON.parse(ev.target.result);
                const isPhb = file.name.toLowerCase().includes('phb');
                const targetLayer = isPhb ? layerPhb : layerMikro;
                const color = isPhb ? '#1e40af' : '#06b6d4';

                L.geoJSON(data, {
                    style: getArrowStyle(color),
                    onEachFeature: (feature, layer) => {
                        // Menambahkan Popup Informasi
                        let p = feature.properties;
                        layer.bindPopup(`<strong>${isPhb ? 'Sal. Phb' : 'Sal. Mikro'}</strong><br>Nama: ${p.toponimi || p.Name || '-'}`);
                        
                        // LOGIKA PANAH: Membuat marker panah di tengah garis
                        if (feature.geometry.type === 'LineString') {
                            const coords = feature.geometry.coordinates;
                            if (coords.length > 1) {
                                // Ambil titik tengah untuk meletakkan panah
                                const midIdx = Math.floor(coords.length / 2);
                                const p1 = coords[midIdx];
                                const p2 = coords[midIdx + 1] || coords[midIdx];
                                
                                // Hitung rotasi berdasarkan koordinat (Hulu ke Hilir)
                                const angle = Math.atan2(p2[1] - p1[1], p2[0] - p1[0]) * 180 / Math.PI;
                                
                                // Simbol panah menggunakan Icon Div
                                const arrowIcon = L.divIcon({
                                    className: 'flow-arrow',
                                    html: `<div style="transform: rotate(${-angle}deg); color: ${color}; font-weight: bold; font-size: 14px;">➤</div>`,
                                    iconSize: [20, 20],
                                    iconAnchor: [10, 10]
                                });
                                
                                L.marker([p1[1], p1[0]], { icon: arrowIcon, interactive: false }).addTo(targetLayer);
                            }
                        }
                    }
                }).addTo(targetLayer);
            };
            reader.readAsText(file);
        }
    };

    // Logika Analisis DAS (Thiessen) - Tetap Dikunci
    document.getElementById('fDAS').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const json = JSON.parse(ev.target.result);
            analysisLayer.clearLayers();
            L.geoJSON(json, { style: { color: 'red', fillOpacity: 0.1 } }).addTo(analysisLayer);
            map.fitBounds(L.geoJSON(json).getBounds());
            document.getElementById('resThiessen').style.display = 'block';
            document.getElementById('resYearly').style.display = 'block';
            document.getElementById('resFreq').style.display = 'block';
            // Simulasi hasil analisis frekuensi
            document.getElementById('fBody').innerHTML = "<tr><td>2 Th</td><td>120.5 mm</td></tr><tr><td>5 Th</td><td>145.2 mm</td></tr>";
        };
        reader.readAsText(file);
    };

</script>

<style>
    .flow-arrow {
        background: none;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 1px 1px white;
    }
</style>

</body>
</html>
