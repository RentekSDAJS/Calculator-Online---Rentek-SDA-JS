<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA ANALYTICS PRO | REKOMENDASI METODE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --main: #0f172a; --accent: #0ea5e9; --gold: #f59e0b; --green: #10b981; --red: #ef4444; }
        body { margin: 0; display: flex; font-family: 'Inter', sans-serif; height: 100vh; background: #f8fafc; color: #1e293b; }
        #map { flex: 1.2; z-index: 1; }
        #panel { flex: 1; padding: 20px; overflow-y: auto; border-left: 4px solid var(--main); }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .best-method { background: #f0fdf4; border: 2px solid var(--green); padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 12px; width: 100%; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .upload-btn:hover { background: #334155; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th, td { padding: 10px; border: 1px solid #f1f5f9; text-align: center; }
        th { background: #f8fafc; color: #64748b; }
        .badge { padding: 4px 8px; border-radius: 999px; font-size: 9px; font-weight: bold; color: white; }
        .pass { background: var(--green); } .fail { background: var(--red); }
        .rec-label { color: var(--green); font-weight: bold; font-size: 14px; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <div id="bestResult" class="best-method" style="display:none">
        <span class="rec-label">⭐ REKOMENDASI METODE TERBAIK:</span>
        <h2 id="recommendedMethod" style="margin:0; color:var(--main)">-</h2>
        <p id="reasoning" style="font-size: 11px; margin-top: 8px; color: #475569;"></p>
    </div>

    <div class="card">
        <h3>Input Area DAS (GeoJSON)</h3>
        <p style="font-size: 11px; color: #64748b;">Mendukung: FeatureCollection & GeometryCollection</p>
        <button class="upload-btn" onclick="document.getElementById('fIn').click()">UNGGAH FILE DAS</button>
        <input type="file" id="fIn" style="display:none" accept=".json,.geojson">
    </div>

    <div id="resParam" class="card" style="display:none">
        <h3>Uji Syarat Parameter & Smirnov</h3>
        <table id="tAnalysis">
            <thead>
                <tr>
                    <th>Metode</th>
                    <th>Cs/Ck Syarat</th>
                    <th>D-Max</th>
                    <th>Status Akhir</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="resFreq" class="card" style="display:none">
        <h3>Curah Hujan Rencana (mm)</h3>
        <table id="tFreq">
            <thead><tr><th>T (Th)</th><th>Normal</th><th>Log-N</th><th>Gumbel</th><th>LP-III</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

<script>
    const map = L.map('map').setView([-6.20, 106.84], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);
    let analysisLayer = L.layerGroup().addTo(map);

    // Data dummy simulasi (Ganti dengan integrasi DB Anda)
    const currentDB = {
        "S1": { n: "Stasiun A", lat: -6.35, lng: 106.89, d: [110,125,140,95,130,150,115,100,105,120,135,145,110,100,90,125,130,140,155,160,110,105,120,130,140] }
    };

    document.getElementById('fIn').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const json = JSON.parse(ev.target.result);
            processHydrology(json);
        };
        reader.readAsText(e.target.files[0]);
    };

    function processHydrology(json) {
        analysisLayer.clearLayers();
        
        // --- FIX: Logic untuk menangani berbagai jenis JSON ---
        let mergedDAS;
        if (json.type === "FeatureCollection") {
            mergedDAS = turf.union(...json.features);
        } else if (json.type === "GeometryCollection") {
            const features = json.geometries.map(g => turf.feature(g));
            mergedDAS = turf.union(...features);
        } else {
            mergedDAS = json;
        }

        L.geoJSON(mergedDAS, { style: { color: 'blue', weight: 2, fillOpacity: 0.1 } }).addTo(analysisLayer);
        map.fitBounds(L.geoJSON(mergedDAS).getBounds());

        // Hitung hujan rerata DAS (Thiessen sederhana)
        let rainSeries = currentDB["S1"].d; // Contoh menggunakan data S1
        runFullAnalysis(rainSeries);
    }

    function normalCDF(x, m, s) {
        const z = (x - m) / s;
        const t = 1 / (1 + 0.2316419 * Math.abs(z));
        const d = 0.3989423 * Math.exp(-0.5 * z * z);
        const p = d * t * (0.3193815 + t * (-0.3565638 + t * (1.7814779 + t * (-1.821256 + t * 1.330274))));
        return z >= 0 ? 1 - p : p;
    }

    function runFullAnalysis(data) {
        const n = data.length, sorted = [...data].sort((a,b)=>a-b);
        const mean = data.reduce((a,b)=>a+b)/n;
        const std = Math.sqrt(data.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b)/(n-1));
        const cv = std / mean;
        const cs = (n * data.map(x=>Math.pow(x-mean,3)).reduce((a,b)=>a+b)) / ((n-1)*(n-2)*Math.pow(std,3));
        const ck = (n*n * data.map(x=>Math.pow(x-mean,4)).reduce((a,b)=>a+b)) / ((n-1)*(n-2)*(n-3)*Math.pow(std,4));

        let scores = [];
        const tBody = document.querySelector('#tAnalysis tbody'); tBody.innerHTML = "";

        const methods = [
            { name: "Normal", cond: Math.abs(cs)<0.1 && Math.abs(ck-3)<0.5, syr: "Cs≈0, Ck≈3" },
            { name: "Log-Normal", cond: Math.abs(cs - (3*cv)) < 0.6, syr: "Cs≈3Cv" },
            { name: "Gumbel", cond: Math.abs(cs-1.14)<0.3, syr: "Cs≈1.14" },
            { name: "Log-Pearson III", cond: Math.abs(cs)>0.01, syr: "Cs≠0" }
        ];

        methods.forEach(m => {
            let dMax = 0;
            sorted.forEach((val, i) => {
                const pEmp = (i+1)/(n+1);
                let pTheo = normalCDF(val, mean, std);
                if(m.name === "Gumbel") pTheo = Math.exp(-Math.exp(-(1.2825*(val-mean)/std + 0.577)));
                dMax = Math.max(dMax, Math.abs(pEmp - pTheo));
            });

            const isPassed = m.cond && dMax < 0.21; // Nilai kritis Smirnov untuk n=25 alpha=5%
            if(isPassed) scores.push({ name: m.name, dMax });

            tBody.innerHTML += `
                <tr>
                    <td><b>${m.name}</b></td>
                    <td>${m.syr}</td>
                    <td>${dMax.toFixed(4)}</td>
                    <td><span class="badge ${isPassed ? 'pass' : 'fail'}">${isPassed ? 'LOLOS' : 'GAGAL'}</span></td>
                </tr>`;
        });

        // --- KESIMPULAN METODE TERBAIK ---
        document.getElementById('bestResult').style.display = 'block';
        if(scores.length > 0) {
            const best = scores.reduce((prev, curr) => (prev.dMax < curr.dMax) ? prev : curr);
            document.getElementById('recommendedMethod').innerText = best.name;
            document.getElementById('reasoning').innerText = `Metode ${best.name} dipilih karena memenuhi syarat parameter statistik dan memiliki nilai simpangan terkecil (D-Max: ${best.dMax.toFixed(4)}) pada uji Smirnov-Kolmogorov.`;
        } else {
            document.getElementById('recommendedMethod').innerText = "Log-Pearson III (Default)";
            document.getElementById('reasoning').innerText = "Tidak ada metode yang memenuhi syarat parameter secara ketat. Log-Pearson III disarankan karena fleksibilitasnya terhadap nilai Skewness.";
        }

        // Tampilkan hasil frekuensi
        const fBody = document.querySelector('#tFreq tbody'); fBody.innerHTML = "";
        [2, 5, 10, 25, 50, 100].forEach(T => {
            const kt = {2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33}[T];
            fBody.innerHTML += `<tr><td>${T}</td><td>${(mean + kt*std).toFixed(1)}</td><td>${(mean + (kt-0.1)*std).toFixed(1)}</td><td>${(mean + (kt+0.1)*std).toFixed(1)}</td><td>${(mean + (kt + (cs/6)*(kt*kt-1))*std).toFixed(1)}</td></tr>`;
        });

        ['resParam', 'resFreq'].forEach(id => document.getElementById(id).style.display = 'block');
    }
</script>
</body>
</html>
