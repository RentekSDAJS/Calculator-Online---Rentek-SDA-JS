<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS PRO | MULTIFUNGSI</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; --green: #059669; --red: #dc2626; --blue: #2563eb; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        
        #map { flex: 2; z-index: 1; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 10px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; font-size: 12px; }
        
        h2 { margin-top: 0; color: var(--main); font-size: 1.4rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        h3 { font-size: 10px; text-transform: uppercase; color: #64748b; margin: 0 0 10px 0; border-bottom: 1px solid #e2e8f0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #f1f5f9; padding: 8px; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        
        .station-label {
            background: rgba(255, 255, 255, 0.9) !important; border: 1px solid #1e293b !important;
            border-radius: 3px !important; padding: 1px 4px !important; font-weight: 800 !important;
            color: #1e293b !important; font-size: 11px !important;
        }
        
        .scroll-container { max-height: 120px; overflow-y: auto; border: 1px solid #e2e8f0; }
        .best-badge { background: var(--main); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 15px; border-left: 5px solid var(--accent); }
        
        /* Gaya untuk Input File Tambahan */
        .input-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2>HYDRO-SPATIAL ULTIMATE</h2>
    <div id="dbStatus"></div>

    <div class="card">
        <h3>1. Manajemen Layer & Input</h3>
        <div class="input-group">
            <button class="upload-btn" style="background:#dc2626" onclick="document.getElementById('fDAS').click()">+ LAYER DAS (ANALISIS)</button>
            <button class="upload-btn" style="background:#2563eb" onclick="document.getElementById('fSaluran').click()">+ LAYER SALURAN (GEOJSON)</button>
            <button class="upload-btn" style="background:#059669" onclick="document.getElementById('fLain').click()">+ LAYER LAINNYA</button>
        </div>
        
        <input type="file" id="fDAS" style="display:none" accept=".json,.geojson">
        <input type="file" id="fSaluran" style="display:none" accept=".json,.geojson">
        <input type="file" id="fLain" style="display:none" accept=".json,.geojson">
    </div>

    <div id="resThiessen" class="card" style="display:none">
        <h3>2. Koefisien Thiessen</h3>
        <tbody id="tBody"></tbody>
    </div>

    <div id="resYearly" class="card" style="display:none">
        <h3>3. Hujan Rerata Wilayah (2000+)</h3>
        <div class="scroll-container"><table><tbody id="yBody"></tbody></table></div>
    </div>

    <div id="resTest" class="card" style="display:none">
        <h3>4. Uji Kesesuaian & Frekuensi</h3>
        <div id="bestMethod"></div>
        <table style="margin-top:10px"><thead><tr><th>Metode</th><th>S-K</th><th>Chi</th><th>Status</th></tr></thead><tbody id="testBody"></tbody></table>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    
    // Inisialisasi Peta
    const map = L.map('map').setView([-6.20, 106.84], 12);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    // Grup Layer
    let dasGroup = L.layerGroup().addTo(map);
    let saluranGroup = L.layerGroup().addTo(map);
    let extraGroup = L.layerGroup().addTo(map);
    let stMarkers = L.layerGroup().addTo(map);

    // 1. FITUR PENCARIAN LOKASI
    L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

    // KONTROL LAYER (Multifungsi)
    const baseMaps = { "OpenStreetMap": osm, "Satelit": satelit };
    const overlayMaps = { 
        "Analisis DAS": dasGroup, 
        "Jaringan Saluran": saluranGroup, 
        "Layer Tambahan": extraGroup,
        "Stasiun Hujan": stMarkers 
    };
    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    let currentDB = null;

    function refreshDatabase() {
        const rawData = localStorage.getItem('sda_db_final_clean');
        if (rawData) {
            currentDB = JSON.parse(rawData);
            document.getElementById('dbStatus').innerHTML = `<small style="color:green">‚óè Database OK</small>`;
            stMarkers.clearLayers();
            Object.keys(currentDB).forEach(id => {
                const st = currentDB[id];
                const marker = L.circleMarker([st.lat, st.lng], { radius: 6, color: '#1e293b', fillColor: '#f59e0b', fillOpacity: 1, weight: 2 });
                marker.bindTooltip(st.n, { permanent: true, direction: 'top', className: 'station-label' });
                marker.bindPopup(`Lat: ${st.lat}<br>Long: ${st.lng}`);
                marker.addTo(stMarkers);
            });
        }
    }
    refreshDatabase();

    // 2. LOGIKA INPUT SALURAN (DENGAN ATRIBUT)
    document.getElementById('fSaluran').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            L.geoJSON(data, {
                style: { color: '#2563eb', weight: 4, opacity: 0.8 },
                onEachFeature: (feature, layer) => {
                    // Menampilkan semua atribut yang ada di file GeoJSON
                    let props = feature.properties;
                    let content = "<table style='font-size:11px'>";
                    for (let key in props) {
                        content += `<tr><td><b>${key}</b></td><td>: ${props[key]}</td></tr>`;
                    }
                    content += "</table>";
                    layer.bindPopup("<b>INFO SALURAN</b><br>" + content);
                }
            }).addTo(saluranGroup);
            map.fitBounds(saluranGroup.getBounds());
            alert("Layer Saluran Berhasil Dimuat!");
        };
        reader.readAsText(file);
    };

    // 3. LAYER LAINNYA
    document.getElementById('fLain').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const data = JSON.parse(ev.target.result);
            L.geoJSON(data, { 
                style: { color: '#059669', weight: 2, fillOpacity: 0.3 } 
            }).addTo(extraGroup);
            alert("Layer Tambahan Berhasil Dimuat!");
        };
        reader.readAsText(file);
    };

    // LOGIKA DAS & ANALISIS (TETAP DIKUNCI SEPERTI SEBELUMNYA)
    document.getElementById('fDAS').onchange = (e) => {
        const file = e.target.files[0];
        if (!file || !currentDB) return;
        const reader = new FileReader();
        reader.onload = (ev) => processHydrology(JSON.parse(ev.target.result));
        reader.readAsText(file);
    };

    function processHydrology(json) {
        dasGroup.clearLayers();
        // ... (Logika Analisis Hidrologi Anda yang lama tetap di sini tanpa perubahan) ...
        // (Pastikan fungsi processHydrology dan runFullAnalysis di-copy ke sini secara utuh dari kode sebelumnya)
        // ...
        document.getElementById('resThiessen').style.display = 'block'; // Contoh aktivasi panel
        alert("Analisis Hidrologi Selesai!");
    }
</script>
</body>
</html>
