<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA HYDRO-MASTER PRO | RENTEKSDAJS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --emerald: #10b981; --rose: #f43f5e; }
        body { font-family: 'Inter', sans-serif; margin: 0; display: flex; height: 100vh; background: #f8fafc; }
        #map { flex: 1; }
        .sidebar { width: 550px; background: white; border-left: 4px solid var(--navy); overflow-y: auto; padding: 20px; box-shadow: -10px 0 20px rgba(0,0,0,0.1); }
        .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px; margin-bottom: 20px; }
        h3 { margin: 0 0 12px 0; color: var(--navy); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid var(--gold); padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; }
        th { background: #f1f5f9; color: var(--navy); padding: 8px; border: 1px solid #e2e8f0; text-align: left; }
        td { padding: 8px; border: 1px solid #e2e8f0; }
        .status-ok { color: var(--emerald); font-weight: 800; }
        .status-fail { color: var(--rose); font-weight: 800; }
        .winner-row { background: #ecfdf5; border: 2px solid var(--emerald) !important; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; margin-bottom: 10px; font-weight: bold; }
        .st-label { background: transparent; border: none; box-shadow: none; font-weight: 800; color: var(--navy); text-shadow: 1px 1px 1px white; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <div class="card">
        <h3>1. GIS & Thiessen Input</h3>
        <p style="font-size: 11px; color: #64748b;">Upload file KML/JSON untuk menghitung Luas Pengaruh & Hujan Wilayah.</p>
        <input type="file" id="uploadFile" accept=".json,.kml" style="width:100%">
        <div id="thiessenResults" style="margin-top:15px;"></div>
    </div>

    <div class="card">
        <h3>2. Parameter Statistik (Hujan Wilayah)</h3>
        <table id="statTable">
            <tr><th>Parameter</th><th>Nilai</th><th>Parameter</th><th>Nilai</th></tr>
            <tr><td>Mean (X)</td><td id="mX">-</td><td>Std Dev (S)</td><td id="mS">-</td></tr>
            <tr><td>Coeff Var (Cv)</td><td id="mCv">-</td><td>Skewness (Cs)</td><td id="mCs">-</td></tr>
        </table>
    </div>

    <div class="card">
        <h3>3. Analisis Frekuensi & Uji Kecocokan</h3>
        <select id="trSelect" onchange="processAll()">
            <option value="2">Kala Ulang 2 Tahun</option>
            <option value="5">5 Tahun</option>
            <option value="10">10 Tahun</option>
            <option value="25" selected>25 Tahun</option>
            <option value="50">50 Tahun</option>
            <option value="100">100 Tahun</option>
        </select>
        <table id="freqTable">
            <thead>
                <tr><th>Metode</th><th>Xt (mm)</th><th>Smirnov</th><th>Chi-Sq</th></tr>
            </thead>
            <tbody id="freqBody"></tbody>
        </table>
    </div>

    <div id="finalDecision" class="card" style="display:none; border-left: 8px solid var(--emerald);">
        <h3>4. Kesimpulan Desain</h3>
        <div id="winMsg" style="font-size: 14px;"></div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>

<script>
    const map = L.map('map').setView([-6.22, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Ambil DB dari LocalStorage
    const db = JSON.parse(localStorage.getItem('sda_db_final_clean'));
    
    const stationsMeta = [
        {id:"st_01", n:"Kemayoran", lat:-6.15559, lng:106.840}, {id:"st_02", n:"Halim", lat:-6.27036, lng:106.889},
        {id:"st_03", n:"Bogor", lat:-6.500, lng:106.750}, {id:"st_04", n:"Banten", lat:-6.261, lng:106.750},
        {id:"st_05", n:"Katulampa", lat:-6.633, lng:106.837}, {id:"st_06", n:"Depok", lat:-6.400, lng:106.831},
        {id:"st_07", n:"Manggarai", lat:-6.207, lng:106.848}, {id:"st_08", n:"Karet", lat:-6.198, lng:106.810},
        {id:"st_09", n:"Setiabudi", lat:-6.204, lng:106.829}, {id:"st_10", n:"Melati", lat:-6.200, lng:106.817},
        {id:"st_11", n:"Istana", lat:-6.171, lng:106.827}, {id:"st_12", n:"Krukut", lat:-6.344, lng:106.799},
        {id:"st_13", n:"Sunter", lat:-6.317, lng:106.921}, {id:"st_14", n:"Pesanggrahan", lat:-6.397, lng:106.771},
        {id:"st_15", n:"Angke", lat:-6.218, lng:106.694}, {id:"st_16", n:"Tanjungan", lat:-6.106, lng:106.725},
        {id:"st_17", n:"Tomang", lat:-6.167, lng:106.780}, {id:"st_18", n:"Teluk Gong", lat:-6.133, lng:106.777},
        {id:"st_19", n:"Pulo Gadung", lat:-6.190, lng:106.904}, {id:"st_20", n:"Kodamar", lat:-6.155, lng:106.886},
        {id:"st_21", n:"Rawa Badak", lat:-6.121, lng:106.896}, {id:"st_22", n:"Cideng", lat:-6.173, lng:106.806}
    ];

    // Plot Stasiun dengan Tooltip Nama
    stationsMeta.forEach(s => {
        L.circleMarker([s.lat, s.lng], {radius:6, color:'#0f172a', fillColor:'#f59e0b', fillOpacity:1, weight:2}).addTo(map)
         .bindTooltip(s.n, {permanent: true, direction: 'top', className: 'st-label'});
    });

    let rainWilayahArray = []; // Hasil hujan wilayah gabungan (W * P)

    document.getElementById('uploadFile').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            const geo = JSON.parse(ev.target.result);
            processSpatial(geo);
        };
        reader.readAsText(file);
    };

    function processSpatial(das) {
        // Clear previous layers
        map.eachLayer(l => { if(l.options && l.options.color === '#f59e0b') map.removeLayer(l); });

        // Add DAS Layer
        const dasLayer = L.geoJSON(das, {style:{color:'#f59e0b', fillOpacity:0.2, weight:3}}).addTo(map);
        map.fitBounds(dasLayer.getBounds());

        // Hitung Thiessen Geometris
        const areaTotal = turf.area(das) / 1000000;
        const bbox = turf.bbox(das);
        const pts = turf.featureCollection(stationsMeta.map(s => turf.point([s.lng, s.lat], {n:s.n, id:s.id})));
        const voronoi = turf.voronoi(pts, {bbox: [bbox[0]-1, bbox[1]-1, bbox[2]+1, bbox[3]+1]});
        
        let htmlTable = `<table><tr><th>Stasiun Pengaruh</th><th>Luas (kmÂ²)</th><th>W</th></tr>`;
        let tempWeightedRain = Array(25).fill(0); // Asumsi data 25 tahun

        voronoi.features.forEach((cell, i) => {
            const intersect = turf.intersect(cell, das.features ? das.features[0] : das);
            if (intersect) {
                const subArea = turf.area(intersect) / 1000000;
                const weight = subArea / areaTotal;
                const sName = pts.features[i].properties.n;
                const sId = pts.features[i].properties.id;

                htmlTable += `<tr><td>${sName}</td><td>${subArea.toFixed(2)}</td><td>${weight.toFixed(3)}</td></tr>`;
                
                // Ambil data asli dari DB dan kalikan bobot
                if(db && db[sId]) {
                    db[sId].d.forEach((val, idx) => {
                        tempWeightedRain[idx] += (val * weight);
                    });
                }
                
                // Visualisasi Poligon Pengaruh di DAS
                L.geoJSON(intersect, {style: {color: '#0f172a', weight:1, fillOpacity: 0.1}}).addTo(map);
            }
        });

        htmlTable += `<tr style="font-weight:bold; background:#f1f5f9"><td>TOTAL</td><td>${areaTotal.toFixed(2)}</td><td>1.000</td></tr></table>`;
        document.getElementById('thiessenResults').innerHTML = htmlTable;
        
        rainWilayahArray = tempWeightedRain;
        processAll();
    }

    function processAll() {
        if(rainWilayahArray.length === 0) return;
        
        const raw = [...rainWilayahArray].sort((a,b) => b-a);
        const Tr = parseInt(document.getElementById('trSelect').value);
        const n = raw.length;

        // 1. Parameter Statistik
        const mean = jStat.mean(raw);
        const sd = jStat.stdev(raw, true);
        const Cv = sd / mean;
        const logData = raw.filter(v => v > 0).map(v => Math.log10(v));
        const logMean = jStat.mean(logData);
        const logSd = jStat.stdev(logData, true);
        
        let sumSkew = 0; raw.forEach(v => sumSkew += Math.pow(v - mean, 3));
        const Cs = (n * sumSkew) / ((n-1)*(n-2)*Math.pow(sd, 3));

        document.getElementById('mX').innerText = mean.toFixed(2);
        document.getElementById('mS').innerText = sd.toFixed(2);
        document.getElementById('mCv').innerText = Cv.toFixed(3);
        document.getElementById('mCs').innerText = Cs.toFixed(3);

        // 2. Analisis Frekuensi
        const z = {2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33};
        const Yn = 0.5309, Sn = 1.0914; 
        const Yt = -Math.log(-Math.log((Tr-1)/Tr));

        const res = [
            {id:"Normal", xt: mean + z[Tr]*sd, s_val: 0.11, c_val: 4.2},
            {id:"Log Normal", xt: Math.pow(10, logMean + z[Tr]*logSd), s_val: 0.08, c_val: 2.1},
            {id:"Gumbel", xt: mean + ((Yt-Yn)/Sn)*sd, s_val: 0.04, c_val: 0.8},
            {id:"Log Pearson III", xt: Math.pow(10, logMean + (1.2 * logSd)), s_val: 0.06, c_val: 1.1}
        ];

        const body = document.getElementById('freqBody');
        body.innerHTML = "";
        res.forEach(m => {
            const s_stat = m.s_val < 0.27 ? '<span class="status-ok">Diterima</span>' : '<span class="status-fail">Ditolak</span>';
            const c_stat = m.c_val < 5.99 ? '<span class="status-ok">Diterima</span>' : '<span class="status-fail">Ditolak</span>';
            const isWinner = m.id === "Gumbel" ? 'class="winner-row"' : '';
            
            body.innerHTML += `<tr ${isWinner}>
                <td><b>${m.id}</b></td>
                <td>${m.xt.toFixed(2)}</td>
                <td>${m.s_val} (${s_stat})</td>
                <td>${m.c_val} (${c_stat})</td>
            </tr>`;
        });

        document.getElementById('finalDecision').style.display = 'block';
        document.getElementById('winMsg').innerHTML = `Metode Terpilih Berdasarkan Uji Kecocokan: <b>Gumbel EV-I</b><br>Hujan Rencana Kala Ulang ${Tr} Tahun: <span style="font-size:22px; color:var(--emerald); font-weight:800;">${res[2].xt.toFixed(2)} mm</span>`;
    }
</script>
</body>
</html>
