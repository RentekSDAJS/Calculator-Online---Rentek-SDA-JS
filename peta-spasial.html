<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS | ANALISIS HIDRO-SPASIAL FINAL</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; --green: #059669; --red: #dc2626; --blue: #2563eb; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        #map { flex: 1.2; z-index: 1; }
        #panel { flex: 1; padding: 25px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 12px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        h2 { margin-top:0; color:var(--main); font-size: 1.3rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        h3 { font-size: 11px; text-transform: uppercase; color: #64748b; margin-top: 0; letter-spacing: 1px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 5px; }
        th { background: #f1f5f9; color: #475569; padding: 8px; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .badge-test { font-size: 8px; padding: 2px 4px; border-radius: 3px; font-weight: bold; display: inline-block; margin-top: 2px; }
        .pass { background: #dcfce7; color: #166534; border: 1px solid #166534; }
        .fail { background: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
        .color-box { width: 12px; height: 12px; display: inline-block; margin-right: 5px; border-radius: 2px; vertical-align: middle; }
        .station-label { background: white !important; border: 1px solid #1e293b !important; padding: 2px 5px !important; font-weight: bold !important; font-size: 10px !important; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2>HYDRO-SPATIAL ANALYTICS</h2>
    <div id="dbStatus"></div>

    <div class="card">
        <h3>1. Input Area DAS (JSON)</h3>
        <button class="upload-btn" onclick="document.getElementById('fIn').click()">PILIH FILE DAS</button>
        <input type="file" id="fIn" style="display:none" accept=".json,.geojson">
    </div>

    <div id="resThiessen" class="card" style="display:none">
        <h3>2. Koefisien Thiessen & Pengaruh</h3>
        <table>
            <thead><tr><th>Stn</th><th>Nama Stasiun</th><th>Luas (km²)</th><th>Koef (W)</th></tr></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>

    <div id="resHistory" class="card" style="display:none">
        </div>

    <div id="resFreq" class="card" style="display:none">
        <h3>4. Analisis Frekuensi DAS (mm)</h3>
        <table>
            <thead><tr><th>T (Th)</th><th>Normal</th><th>Log-N</th><th>Gumbel</th><th>LP-III</th></tr></thead>
            <tbody id="fBody"></tbody>
        </table>
    </div>

    <div id="resTest" class="card" style="display:none">
        <h3>5. Hasil Uji Kelolosan Statistik</h3>
        <table>
            <thead>
                <tr>
                    <th>Metode</th>
                    <th>Param</th>
                    <th>S-K (Dmax)</th>
                    <th>Chi-Sq</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="testBody"></tbody>
        </table>
        <div id="finalVerdict" style="margin-top:15px;"></div>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    const map = L.map('map').setView([-6.20, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);

    let dasLayer, analysisLayer = L.layerGroup().addTo(map), stMarkers = L.layerGroup().addTo(map), currentDB = null;

    function refreshDatabase() {
        const rawData = localStorage.getItem('sda_db_final_clean');
        if (rawData) {
            currentDB = JSON.parse(rawData);
            document.getElementById('dbStatus').innerHTML = `<div style='font-size:11px; color:green; margin-bottom:10px;'>● DATABASE TERHUBUNG (${Object.keys(currentDB).length} Stasiun)</div>`;
            stMarkers.clearLayers();
            Object.keys(currentDB).forEach(id => {
                const st = currentDB[id];
                L.circleMarker([st.lat, st.lng], { radius: 6, color: '#1e293b', fillColor: '#f59e0b', fillOpacity: 1 })
                 .addTo(stMarkers)
                 .bindTooltip(`<b>${st.n}</b>`, { permanent: true, direction: 'top', className: 'station-label' });
            });
        }
    }
    refreshDatabase();

    document.getElementById('fIn').onchange = (e) => {
        const file = e.target.files[0];
        if (!file || !currentDB) return;
        const reader = new FileReader();
        reader.onload = (ev) => processHydrology(JSON.parse(ev.target.result));
        reader.readAsText(file);
    };

    function erf(x) {
        const a = [0.254829592, -0.284496736, 1.421413741, -1.453152027, 1.061405429];
        const p = 0.3275911, sign = (x < 0) ? -1 : 1;
        x = Math.abs(x);
        const t = 1.0 / (1.0 + p * x);
        const y = 1.0 - (((((a[4] * t + a[3]) * t + a[2]) * t + a[1]) * t + a[0]) * t * Math.exp(-x * x));
        return sign * y;
    }

    function normalCDF(x, mean, std) {
        return 0.5 * (1 + erf((x - mean) / (std * Math.sqrt(2))));
    }

    function processHydrology(json) {
        if (dasLayer) map.removeLayer(dasLayer);
        analysisLayer.clearLayers();
        document.getElementById('tBody').innerHTML = "";

        let mergedDAS, features = json.features || [json];
        features.forEach(f => {
            f.geometry.coordinates = f.geometry.coordinates.map(c => Array.isArray(c[0]) ? c.map(cc => cc[0] > 1000 ? proj4("EPSG:32748", "WGS84", cc) : cc) : (c[0] > 1000 ? proj4("EPSG:32748", "WGS84", c) : c));
            mergedDAS = mergedDAS ? turf.union(mergedDAS, f) : f;
        });

        dasLayer = L.geoJSON(mergedDAS, { style: { color: '#dc2626', weight: 3, fillOpacity: 0 } }).addTo(map);
        map.fitBounds(dasLayer.getBounds());
        
        const pts = turf.featureCollection(Object.keys(currentDB).map(id => turf.point([currentDB[id].lng, currentDB[id].lat], { id: id, n: currentDB[id].n })));
        const voronoi = turf.voronoi(pts, { bbox: turf.bbox(mergedDAS) });
        
        let results = [], totalArea = 0;
        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, mergedDAS);
            if (clip) {
                const area = turf.area(clip) / 1000000;
                const color = `hsl(${(i * 140) % 360}, 65%, 65%)`;
                totalArea += area;
                results.push({ id: pts.features[i].properties.id, name: pts.features[i].properties.n, area: area, color: color });
                L.geoJSON(clip, { style: { color: 'white', weight: 1, fillColor: color, fillOpacity: 0.6 } }).addTo(analysisLayer);
            }
        });

        results.forEach(res => {
            res.w = res.area / totalArea;
            document.getElementById('tBody').innerHTML += `<tr><td><span class="color-box" style="background:${res.color}"></span></td><td>${res.name}</td><td>${res.area.toFixed(2)}</td><td>${res.w.toFixed(4)}</td></tr>`;
        });

        // HITUNG HUJAN RERATA WILAYAH PER TAHUN (MULAI 2000)
        let rainSeries = [];
        let historyHTML = `<h3>3. Histori Hujan Rerata Wilayah (mm)</h3><table><thead><tr><th>Tahun</th><th>Hujan Rerata (P)</th></tr></thead><tbody>`;
        
        const startYear = 2000;
        const yearsCount = currentDB[Object.keys(currentDB)[0]].d.length;

        for(let j=0; j < yearsCount; j++) {
            let pRerata = 0;
            results.forEach(res => { 
                pRerata += currentDB[res.id].d[j] * res.w; 
            });
            rainSeries.push(pRerata);
            historyHTML += `<tr><td>${startYear + j}</td><td><b>${pRerata.toFixed(2)}</b></td></tr>`;
        }
        historyHTML += `</tbody></table>`;
        document.getElementById('resHistory').innerHTML = historyHTML;
        document.getElementById('resHistory').style.display = 'block';

        runAdvancedAnalysis(rainSeries);
        ['resThiessen', 'resFreq', 'resTest'].forEach(id => document.getElementById(id).style.display = 'block');
    }

    function runAdvancedAnalysis(data) {
        const n = data.length, sorted = [...data].sort((a,b) => b-a);
        const mean = data.reduce((a,b)=>a+b)/n;
        const std = Math.sqrt(data.map(x=>Math.pow(x-mean,2)).reduce((a,b)=>a+b)/(n-1));
        const cv = std/mean, cs = (n * data.map(x=>Math.pow(x-mean,3)).reduce((a,b)=>a+b)) / ((n-1)*(n-2)*Math.pow(std,3));
        
        const logData = data.map(x=>Math.log10(x)), lMean = logData.reduce((a,b)=>a+b)/n, lStd = Math.sqrt(logData.map(x=>Math.pow(x-lMean,2)).reduce((a,b)=>a+b)/(n-1));
        const lCs = (n * logData.map(x=>Math.pow(x-lMean,3)).reduce((a,b)=>a+b))/((n-1)*(n-2)*Math.pow(lStd,3));

        const methods = {
            "Normal": t => mean + ({2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33}[t] * std),
            "Log-Normal": t => Math.pow(10, lMean + ({2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33}[t] * lStd)),
            "Gumbel": t => mean + (((-Math.log(-Math.log((t-1)/t)) - 0.577) / 1.2825) * std),
            "Log-Pearson III": t => {
                const kt = {2:0, 5:0.84, 10:1.28, 25:1.75, 50:2.05, 100:2.33}[t];
                const K = (2/lCs) * (Math.pow(((kt - lCs/6)*(lCs/6) + 1), 3) - 1);
                return Math.pow(10, lMean + K*lStd);
            }
        };

        const fBody = document.getElementById('fBody');
        fBody.innerHTML = "";
        [2, 5, 10, 25, 50, 100].forEach(t => {
            fBody.innerHTML += `<tr><td>${t}</td><td>${methods["Normal"](t).toFixed(1)}</td><td>${methods["Log-Normal"](t).toFixed(1)}</td><td>${methods["Gumbel"](t).toFixed(1)}</td><td>${methods["Log-Pearson III"](t).toFixed(1)}</td></tr>`;
        });

        const testBody = document.getElementById('testBody');
        testBody.innerHTML = "";
        const dCrit = 1.36 / Math.sqrt(n), chiCrit = 7.81;
        let best = null;

        Object.keys(methods).forEach(m => {
            let dMax = 0;
            const useLog = m.includes("Log"), tM = useLog ? lMean : mean, tS = useLog ? lStd : std;
            
            sorted.forEach((val, i) => {
                const pEmp = (i + 1) / (n + 1);
                const pTheo = normalCDF(useLog ? Math.log10(val) : val, tM, tS);
                dMax = Math.max(dMax, Math.abs(pEmp - pTheo));
            });

            const chiCalc = (dMax * n * 0.45); 
            const pPass = m === "Log-Pearson III" || (m === "Gumbel" && cs <= 1.14) || (m === "Normal" && Math.abs(cs) < 0.1);
            const skPass = dMax < dCrit, chiPass = chiCalc < chiCrit;
            const finalOk = pPass && skPass && chiPass;

            testBody.innerHTML += `<tr><td><b>${m}</b></td><td>${pPass?'✔':'✘'}</td><td>${dMax.toFixed(4)} <br><span class="badge-test ${skPass?'pass':'fail'}">${skPass?'LOLOS':'GAGAL'}</span></td><td>${chiCalc.toFixed(3)} <br><span class="badge-test ${chiPass?'pass':'fail'}">${chiPass?'LOLOS':'GAGAL'}</span></td><td><span class="badge-test ${finalOk?'pass':'fail'}">${finalOk?'DITERIMA':'DITOLAK'}</span></td></tr>`;
            if(finalOk && !best) best = m;
        });

        document.getElementById('finalVerdict').innerHTML = best ? `<div style="background:var(--green); color:white; padding:12px; border-radius:8px; text-align:center; font-weight:bold;">METODE TERPILIH: ${best.toUpperCase()}</div>` : `<div style="background:var(--red); color:white; padding:12px; border-radius:8px; text-align:center; font-weight:bold;">TIDAK ADA METODE YANG LOLOS SEMUA UJI</div>`;
    }
</script>
</body>
</html>
