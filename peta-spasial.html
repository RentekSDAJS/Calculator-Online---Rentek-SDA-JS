<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS | PERHITUNGAN THIESSEN & RERATA</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; }
        body { margin: 0; display: flex; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        #map { flex: 2; background: #e5e7eb; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; border-left: 4px solid var(--main); }
        .upload-zone { border: 2px dashed var(--accent); padding: 15px; text-align: center; border-radius: 8px; background: #fffbeb; margin-bottom: 20px; cursor: pointer; }
        h3 { color: var(--main); border-bottom: 2px solid var(--accent); padding-bottom: 8px; font-size: 16px; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; }
        th { background: var(--main); color: white; padding: 8px; text-align: left; }
        td { border: 1px solid #e2e8f0; padding: 6px; }
        .highlight { font-weight: 800; color: #059669; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2 style="margin-top:0; color:var(--main)">ANALISIS HIDROLOGI</h2>
    
    <div class="upload-zone" onclick="document.getElementById('fileIn').click()">
        <strong>KLIK UNTUK UPLOAD CATCHMENT</strong><br>
        <small>(Kali Sunter.json / Tebet.json / watershed.json)</small>
        <input type="file" id="fileIn" style="display:none" accept=".json">
    </div>

    <div id="resultsSection" style="display:none">
        <h3>1. Luas Pengaruh Stasiun (Thiessen)</h3>
        <table>
            <thead><tr><th>Stasiun</th><th>Luas (kmÂ²)</th><th>Bobot (W)</th></tr></thead>
            <tbody id="thiessenBody"></tbody>
        </table>

        <h3>2. Hujan Rerata Wilayah Tahunan</h3>
        <table>
            <thead><tr><th>Tahun</th><th>Hujan Wilayah (mm)</th></tr></thead>
            <tbody id="avgRainBody"></tbody>
        </table>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    const map = L.map('map').setView([-6.2297, 106.8295], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Ambil Data dari Portal
    const dbSource = JSON.parse(localStorage.getItem('sda_db_final_clean'));
    const markersGroup = L.layerGroup().addTo(map);
    const thiessenGroup = L.layerGroup().addTo(map);

    // Tampilkan Titik Stasiun dari Portal Hujan
    function showStations() {
        if (!dbSource) return;
        Object.keys(dbSource).forEach(id => {
            const st = dbSource[id];
            L.circleMarker([st.lat, st.lng], { radius: 5, color: 'blue', fillOpacity: 1 })
             .addTo(markersGroup)
             .bindTooltip(st.n, { permanent: true, direction: 'top', offset: [0, -5] });
        });
    }
    showStations();

    // Handle Upload File
    document.getElementById('fileIn').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const geojson = JSON.parse(event.target.result);
            processHydrology(geojson);
        };
        reader.readAsText(file);
    };

    function processHydrology(catchment) {
        thiessenGroup.clearLayers();
        document.getElementById('thiessenBody').innerHTML = "";
        document.getElementById('avgRainBody').innerHTML = "";
        
        // 1. Konversi Koordinat jika UTM
        let features = catchment.features || (catchment.geometries ? catchment.geometries.map(g => ({type: "Feature", geometry: g})) : [catchment]);
        let mainFeature = features[0];

        // Deep copy untuk konversi agar data asli tidak rusak
        let cleanCoords = JSON.parse(JSON.stringify(mainFeature.geometry.coordinates));
        
        const convertCoords = (coords) => {
            return coords.map(c => {
                if (Array.isArray(c[0])) return convertCoords(c);
                return (c[0] > 1000) ? proj4("EPSG:32748", "WGS84", c) : c;
            });
        };

        mainFeature.geometry.coordinates = convertCoords(cleanCoords);
        const catchmentLayer = L.geoJSON(mainFeature, { style: { color: 'red', weight: 2, fillOpacity: 0.1 } }).addTo(thiessenGroup);
        map.fitBounds(catchmentLayer.getBounds());

        // 2. Analisis Spasial Thiessen
        const points = turf.featureCollection(Object.keys(dbSource).map(id => {
            return turf.point([dbSource[id].lng, dbSource[id].lat], { name: dbSource[id].n, id: id });
        }));

        const bbox = turf.bbox(mainFeature);
        const vPolys = turf.voronoi(points, { bbox: bbox });

        let results = [];
        let totalArea = 0;

        vPolys.features.forEach((poly, i) => {
            const clipped = turf.intersect(poly, mainFeature);
            if (clipped) {
                const area = turf.area(clipped) / 1000000;
                const stData = points.features[i].properties;
                totalArea += area;
                results.push({ id: stData.id, name: stData.name, area: area, geo: clipped });
                
                L.geoJSON(clipped, { style: { color: '#3b82f6', weight: 1, fillOpacity: 0.3 } }).addTo(thiessenGroup);
            }
        });

        // 3. Tampilkan Hasil
        results.forEach(r => {
            const weight = r.area / totalArea;
            r.weight = weight;
            document.getElementById('thiessenBody').innerHTML += `<tr><td>${r.name}</td><td>${r.area.toFixed(2)}</td><td>${weight.toFixed(4)}</td></tr>`;
        });

        const tahunCount = dbSource[Object.keys(dbSource)[0]].d.length;
        for (let t = 0; t < tahunCount; t++) {
            let rainAvg = 0;
            results.forEach(r => { rainAvg += (dbSource[r.id].d[t] * r.weight); });
            document.getElementById('avgRainBody').innerHTML += `<tr><td>Tahun ${2000+t}</td><td class="highlight">${rainAvg.toFixed(2)} mm</td></tr>`;
        }
        
        document.getElementById('resultsSection').style.display = 'block';
    }
</script>
</body>
</html>
