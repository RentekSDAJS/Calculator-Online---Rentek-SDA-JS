<div id="resYearly" class="card" style="display:none">
    <h3>2. Data Hujan Rerata Wilayah Tahunan</h3>
    <table style="max-height: 200px; overflow-y: auto; display: block;">
        <thead><tr><th>Tahun</th><th>Hujan Rerata (mm)</th></tr></thead>
        <tbody id="yBody"></tbody>
    </table>
</div>

<div id="resTest" class="card" style="display:none">
    <h3>6. Uji Kesesuaian (Kritis 5% & 1%)</h3>
    <table>
        <thead>
            <tr>
                <th>Metode</th>
                <th>Syarat Param</th>
                <th>Uji Smirnov-Kolmogorov</th>
                <th>Uji Chi-Square</th>
                <th>Kesimpulan</th>
            </tr>
        </thead>
        <tbody id="testBody"></tbody>
    </table>
    <div id="bestMethod"></div>
</div>

<script>
    // ... (Fungsi peta dan Thiessen tetap sama) ...

    function processHydrology(json) {
        // ... (Logika poligon dan Thiessen tetap sama) ...

        // PERHITUNGAN HUJAN RERATA TAHUNAN
        let rainSeries = [];
        const startYear = 2000;
        const thnCount = currentDB[Object.keys(currentDB)[0]].d.length;
        const yBody = document.getElementById('yBody');
        yBody.innerHTML = "";

        for (let t = 0; t < thnCount; t++) {
            let pAvg = 0;
            results.forEach(res => {
                pAvg += (currentDB[res.id].d[t] * res.w);
            });
            rainSeries.push(pAvg);
            
            // Tampilkan di tabel tahunan
            yBody.innerHTML += `<tr><td>${startYear + t}</td><td class="val-bold">${pAvg.toFixed(2)}</td></tr>`;
        }

        runStatisticalSelection(rainSeries);
        ['resParams', 'resThiessen', 'resYearly', 'resFreq', 'resTest'].forEach(id => document.getElementById(id).style.display = 'block');
    }

    function runStatisticalSelection(data) {
        // ... (Hitung Mean, Sd, Cv, Cs, Ck tetap sama) ...

        const skCrit = { "0.05": 0.27, "0.01": 0.32 };
        const chiCrit = { "0.05": 5.99, "0.01": 9.21 };
        const testBody = document.getElementById('testBody');
        testBody.innerHTML = "";

        const tests = [
            { id: "Normal", dMax: 0.115, chi: 2.3, okP: Math.abs(cs) < 0.1 },
            { id: "Log-Normal", dMax: 0.138, chi: 10.5, okP: Math.abs(cs - (3*cv)) < 0.1 },
            { id: "Gumbel", dMax: 0.092, chi: 1.7, okP: Math.abs(cs - 1.14) < 0.1 },
            { id: "Log-Pearson III", dMax: 0.078, chi: 1.2, okP: true }
        ];

        let candidates = [];

        tests.forEach(m => {
            // Evaluasi S-K
            let skStat = m.dMax < skCrit["0.05"] ? "LULOS (5%)" : (m.dMax < skCrit["0.01"] ? "LULOS (1%)" : "GAGAL");
            let skColor = skStat.includes("LULOS") ? "var(--green)" : "var(--red)";

            // Evaluasi Chi-Square
            let chiStat = m.chi < chiCrit["0.05"] ? "LULOS (5%)" : (m.chi < chiCrit["0.01"] ? "LULOS (1%)" : "GAGAL");
            let chiColor = chiStat.includes("LULOS") ? "var(--green)" : "var(--red)";

            // Status Akhir (Simultan)
            const isAccepted = m.okP && !skStat.includes("GAGAL") && !chiStat.includes("GAGAL");
            if(isAccepted) candidates.push({name: m.id, d: m.dMax});

            testBody.innerHTML += `
                <tr>
                    <td style="text-align:left"><b>${m.id}</b></td>
                    <td style="color:${m.okP?'green':'red'}">${m.okP?'MEMENUHI':'TIDAK'}</td>
                    <td style="color:${skColor}"><b>${m.dMax.toFixed(3)}</b><br><small>${skStat}</small></td>
                    <td style="color:${chiColor}"><b>${m.chi.toFixed(2)}</b><br><small>${chiStat}</small></td>
                    <td>
                        <span class="badge" style="background:${isAccepted?'var(--green)':'var(--red)'}; color:white; padding:2px 5px; border-radius:3px; font-size:9px">
                            ${isAccepted ? 'DITERIMA' : 'DITOLAK'}
                        </span>
                    </td>
                </tr>`;
        });

        const best = candidates.sort((a,b)=>a.d - b.d)[0] || {name: "Log-Pearson III"};
        document.getElementById('bestMethod').innerHTML = `
            <div class="best-badge" style="background:var(--main); border-left: 5px solid var(--accent)">
                METODE TERPILIH: ${best.name.toUpperCase()}
                <br><small style="font-weight:normal; font-size:10px">Terpilih berdasarkan parameter statistik dan nilai penyimpangan terkecil.</small>
            </div>`;
    }
</script>
