<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS | ANALISIS SPASIAL PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; --green: #059669; --orange: #ea580c; --red: #dc2626; --blue: #2563eb; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        
        #map { flex: 2; z-index: 1; }
        #panel { flex: 1; padding: 25px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 12px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        
        h2 { margin-top:0; color:var(--main); font-size: 1.5rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        h3 { font-size: 11px; text-transform: uppercase; color: #64748b; margin-top: 0; letter-spacing: 1px; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
        th { background: #f1f5f9; color: #475569; padding: 8px; text-align: center; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        
        .status-tag { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; margin-bottom: 15px; }
        .ok { background: #dcfce7; color: #166534; }
        .err { background: #fee2e2; color: #991b1b; }
        
        .color-dot { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 5px; }
        .val-bold { font-weight: 800; color: var(--main); }
        .best-badge { background: var(--green); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; font-size: 12px; margin-top: 10px; }

        /* Label Stasiun Style */
        .leaflet-tooltip.station-label {
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-weight: 800;
            color: #1e293b;
            text-shadow: 2px 2px 0px white, -2px -2px 0px white, 2px -2px 0px white, -2px 2px 0px white;
            font-size: 10px;
            transition: all 0.3s ease;
        }

        /* Legenda Style */
        .info.legend {
            padding: 10px;
            font: 12px Arial, sans-serif;
            background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 5px;
            line-height: 18px;
        }
        .legend i { width: 14px; height: 14px; float: left; margin-right: 8px; border-radius: 2px; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="panel">
    <h2>HYDRO-SPATIAL ANALYTICS</h2>
    <div id="dbStatus"></div>

    <div class="card">
        <h3>1. Input Area DAS (JSON)</h3>
        <button class="upload-btn" onclick="document.getElementById('fIn').click()">PILIH FILE DAS</button>
        <input type="file" id="fIn" style="display:none" accept=".json,.geojson">
    </div>

    <div id="resThiessen" class="card" style="display:none">
        <h3>2. Koefisien Thiessen</h3>
        <table>
            <thead>
                <tr><th style="text-align:left">STASIUN</th><th>LUAS (km²)</th><th>W</th></tr>
            </thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>

    <div id="resRain" class="card" style="display:none">
        <h3>3. Hujan Rerata DAS (mm)</h3>
        <table>
            <thead>
                <tr><th>TAHUN</th><th>P-RERATA</th></tr>
            </thead>
            <tbody id="rBody"></tbody>
        </table>
    </div>

    <div id="resFreq" class="card" style="display:none">
        <h3>4. Analisis Frekuensi</h3>
        <table>
            <thead>
                <tr><th>T</th><th>Normal</th><th>Log-N</th><th>Gumbel</th><th>LP-III</th></tr>
            </thead>
            <tbody id="fBody"></tbody>
        </table>
        <div id="bestMethod"></div>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    const map = L.map('map').setView([-6.20, 106.84], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.7 }).addTo(map);

    let dasLayer = null;
    let analysisLayer = L.layerGroup().addTo(map);
    let stMarkers = L.layerGroup().addTo(map);

    function loadDB() {
        const rawData = localStorage.getItem('sda_db_final_clean');
        const statusEl = document.getElementById('dbStatus');
        
        if (rawData) {
            const db = JSON.parse(rawData);
            statusEl.innerHTML = `<span class="status-tag ok">● DATABASE TERHUBUNG</span>`;
            stMarkers.clearLayers();
            Object.keys(db).forEach(id => {
                const st = db[id];
                const marker = L.circleMarker([st.lat, st.lng], {
                    radius: 7, color: '#1e293b', fillColor: '#f59e0b', fillOpacity: 1, weight: 2
                }).addTo(stMarkers);

                marker.bindTooltip(st.n, { permanent: true, direction: 'top', offset: [0, -8], className: 'station-label' });
                marker.bindPopup(`<strong>Stasiun ${st.n}</strong><br>LAT: ${st.lat}<br>LNG: ${st.lng}`);
            });
            return db;
        } else {
            statusEl.innerHTML = `<span class="status-tag err">● DATABASE TIDAK DITEMUKAN</span>`;
            return null;
        }
    }

    let currentDB = loadDB();
    window.onfocus = () => { currentDB = loadDB(); };

    document.getElementById('fIn').onchange = function(e) {
        const file = e.target.files[0];
        if (!file || !currentDB) return;
        const reader = new FileReader();
        reader.onload = (ev) => processHydrology(JSON.parse(ev.target.result));
        reader.readAsText(file);
    };

    function processHydrology(json) {
        if (dasLayer) map.removeLayer(dasLayer);
        analysisLayer.clearLayers();
        ['tBody', 'rBody', 'fBody'].forEach(id => document.getElementById(id).innerHTML = "");

        let features = json.features || (json.geometries ? json.geometries.map(g => ({type:"Feature", geometry:g, properties:{}})) : [json]);

        let mergedDAS;
        features.forEach(f => {
            const fix = (coords) => coords.map(c => {
                if (Array.isArray(c[0])) return fix(c);
                return (c[0] > 1000) ? proj4("EPSG:32748", "WGS84", c) : c;
            });
            f.geometry.coordinates = fix(f.geometry.coordinates);
            if (!mergedDAS) mergedDAS = f;
            else mergedDAS = turf.union(mergedDAS, f);
        });

        dasLayer = L.geoJSON(mergedDAS, { style: { color: '#dc2626', weight: 3, fillOpacity: 0 } }).addTo(map);
        map.fitBounds(dasLayer.getBounds());

        const pts = turf.featureCollection(Object.keys(currentDB).map(id => 
            turf.point([currentDB[id].lng, currentDB[id].lat], { name: currentDB[id].n, id: id })
        ));

        const voronoi = turf.voronoi(pts, { bbox: turf.bbox(mergedDAS) });
        let results = [], totalArea = 0;

        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, mergedDAS);
            if (clip) {
                const area = turf.area(clip) / 1000000;
                totalArea += area;
                const color = `hsl(${(i * 137.5) % 360}, 65%, 65%)`;
                results.push({ id: pts.features[i].properties.id, name: pts.features[i].properties.name, area: area, color: color });
                L.geoJSON(clip, { style: { color: 'white', weight: 1.5, fillColor: color, fillOpacity: 0.5 } }).addTo(analysisLayer);
            }
        });

        // Update UI Markers (Active/Inactive)
        const activeIds = results.map(r => r.id);
        stMarkers.eachLayer(marker => {
            const latlng = marker.getLatLng();
            const stId = Object.keys(currentDB).find(k => currentDB[k].lat === latlng.lat && currentDB[k].lng === latlng.lng);
            const tooltip = marker.getTooltip() ? marker.getTooltip().getElement() : null;

            if (activeIds.includes(stId)) {
                marker.setStyle({ fillColor: '#059669', radius: 8, weight: 3, color: '#fff' });
                if(tooltip) { tooltip.style.color = '#059669'; tooltip.style.fontSize = '12px'; tooltip.style.opacity = '1'; }
            } else {
                marker.setStyle({ fillColor: '#cbd5e1', radius: 5, weight: 1, color: '#94a3b8' });
                if(tooltip) { tooltip.style.color = '#94a3b8'; tooltip.style.fontSize = '9px'; tooltip.style.opacity = '0.6'; }
            }
        });

        results.forEach(res => {
            res.w = res.area / totalArea;
            document.getElementById('tBody').innerHTML += `<tr><td style="text-align:left"><span class="color-dot" style="background:${res.color}"></span>${res.name}</td><td>${res.area.toFixed(2)}</td><td class="val-bold">${res.w.toFixed(4)}</td></tr>`;
        });

        let rainSeries = [];
        const thnCount = currentDB[Object.keys(currentDB)[0]].d.length;
        for (let t = 0; t < thnCount; t++) {
            let pAvg = 0;
            results.forEach(res => { pAvg += (currentDB[res.id].d[t] * res.w); });
            rainSeries.push(pAvg);
            document.getElementById('rBody').innerHTML += `<tr><td>Tahun ${2000 + t}</td><td class="val-bold" style="color:var(--green)">${pAvg.toFixed(2)}</td></tr>`;
        }

        runFrequency(rainSeries);
        ['resThiessen', 'resRain', 'resFreq'].forEach(id => document.getElementById(id).style.display = 'block');
    }

    function runFrequency(data) {
        const n = data.length;
        const mean = data.reduce((a, b) => a + b) / n;
        const stdDev = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        const logData = data.map(x => Math.log10(x));
        const logMean = logData.reduce((a, b) => a + b) / n;
        const logStdDev = Math.sqrt(logData.map(x => Math.pow(x - logMean, 2)).reduce((a, b) => a + b) / (n - 1));
        const logSkew = n * logData.map(x => Math.pow(x - logMean, 3)).reduce((a, b) => a + b) / ((n - 1) * (n - 2) * Math.pow(logStdDev, 3));

        const T = [2, 5, 10, 25, 50, 100];
        const fBody = document.getElementById('fBody');
        T.forEach(t => {
            const kt = { 2:0, 5:0.842, 10:1.282, 25:1.751, 50:2.054, 100:2.326 }[t];
            const rN = mean + (kt * stdDev);
            const rLN = Math.pow(10, logMean + (kt * logStdDev));
            const rG = mean + (((-(Math.log(Math.log(t/(t-1)))) - 0.5128)/1.1004) * stdDev);
            const kLP = (2/logSkew) * (Math.pow(((kt - logSkew/6) * logSkew/6 + 1), 3) - 1);
            const rLP = Math.pow(10, logMean + (kLP * logStdDev));
            fBody.innerHTML += `<tr><td><b>${t} Th</b></td><td>${rN.toFixed(1)}</td><td>${rLN.toFixed(1)}</td><td>${rG.toFixed(1)}</td><td class="val-bold" style="color:var(--blue)">${rLP.toFixed(1)}</td></tr>`;
        });
        document.getElementById('bestMethod').innerHTML = `<div class="best-badge">STANDAR PU: LOG PEARSON III (LP-III)</div>`;
    }

    // Legenda
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'info legend');
        div.innerHTML = `
            <h4 style="margin:0 0 8px; font-size:12px; border-bottom:1px solid #ddd">Legenda</h4>
            <div style="margin-bottom:4px"><i style="background:#dc2626; border:1px solid #dc2626"></i> Batas DAS</div>
            <div style="margin-bottom:4px"><i style="background:#059669; border-radius:50%; width:10px; height:10px; margin-top:4px"></i> Stasiun Aktif</div>
            <div style="margin-bottom:4px"><i style="background:#cbd5e1; border-radius:50%; width:10px; height:10px; margin-top:4px"></i> Stasiun Luar</div>
            <div style="margin-bottom:4px"><i style="background:rgba(0,0,0,0.1); border:1px dashed #666"></i> Poligon Thiessen</div>
        `;
        return div;
    };
    legend.addTo(map);
</script>
</body>
</html>
