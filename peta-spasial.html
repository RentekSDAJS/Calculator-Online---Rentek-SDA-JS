<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Multi-Format Catchment Analyzer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #0f172a; }
        #sidebar { width: 450px; background: #1e293b; color: white; padding: 25px; z-index: 1000; overflow-y: auto; border-right: 4px solid #f59e0b; }
        #map { flex: 1; }
        .card { background: #0f172a; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #334155; }
        .btn-file { background: #f59e0b; color: #0f172a; padding: 12px; border-radius: 8px; cursor: pointer; display: block; text-align: center; font-weight: bold; }
        .st-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; color: #e2e8f0; margin-top: 15px; }
        .st-table th { background: #334155; padding: 10px; border: 1px solid #475569; color: #f59e0b; text-align: left; }
        .st-table td { padding: 8px; border: 1px solid #334155; }
        .label-stasiun { background: rgba(15, 23, 42, 0.8); border: 1px solid #f59e0b; color: white; font-weight: bold; font-size: 10px; padding: 2px 5px; border-radius: 4px; white-space: nowrap; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>SPATIAL ANALYZER</h2>
    <p style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 25px;">Input Fleksibel: KML atau JSON</p>
    
    <div class="card">
        <label style="font-weight: bold; font-size: 0.9rem;">Upload Catchment Area:</label><br><br>
        <input type="file" id="fileInput" accept=".json,.geojson,.kml" style="display:none">
        <label for="fileInput" class="btn-file">PILIH FILE (KML / JSON)</label>
        <p style="font-size: 0.65rem; color: #94a3b8; margin-top: 10px;">*Sistem otomatis mendeteksi format dan sistem koordinat.</p>
    </div>

    <div id="output-box" style="display:none;">
        <h3 style="font-size: 1rem; color: #f59e0b; border-bottom: 1px solid #475569; padding-bottom: 10px;">Parameter Pengaruh:</h3>
        <table class="st-table">
            <thead>
                <tr>
                    <th>Nama Stasiun</th>
                    <th>Luas (Ha)</th>
                    <th>Koefisien (C)</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<script src="https://unpkg.com/@mapbox/togeojson"></script>

<script>
    // Database Tetap 22 Stasiun
    const STASIUN_FIXED = [
        { n: "Katulampa", lat: -6.63317, lng: 106.837077 },
        { n: "Depok", lat: -6.40065, lng: 106.831897 },
        { n: "Manggarai", lat: -6.20742, lng: 106.848569 },
        { n: "Karet", lat: -6.1981, lng: 106.810097 },
        { n: "Setiabudi Timur", lat: -6.20462, lng: 106.829385 },
        { n: "Melati", lat: -6.20084, lng: 106.817982 },
        { n: "Istana", lat: -6.17165, lng: 106.8270424 },
        { n: "Krukut Hulu", lat: -6.34434, lng: 106.799081 },
        { n: "Sunter Hulu", lat: -6.31785, lng: 106.9211 },
        { n: "Pesanggrahan", lat: -6.39708, lng: 106.77181 },
        { n: "Angke Hulu", lat: -6.21835, lng: 106.694467 },
        { n: "Tanjungan", lat: -6.10669, lng: 106.725882 },
        { n: "Tomang Barat", lat: -6.1671, lng: 106.78001 },
        { n: "Teluk Gong", lat: -6.1335, lng: 106.777649 },
        { n: "Pulo Gadung", lat: -6.19097, lng: 106.904213 },
        { n: "Sunter Kodamar", lat: -6.15508, lng: 106.886893 },
        { n: "Rawa Badak", lat: -6.12107, lng: 106.896744 },
        { n: "Pompa Cideng", lat: -6.17355, lng: 106.806328 },
        { n: "Stasiun Meteorologi Kemayoran", lat: -6.15559, lng: 106.84 },
        { n: "Halim Perdana Kusuma Jakarta", lat: -6.27036, lng: 106.88926 },
        { n: "Stasiun Klimatologi Jawa Barat (Bogor)", lat: -6.5, lng: 106.75 },
        { n: "Stasiun Klimatologi Banten", lat: -6.26151, lng: 106.75084 }
    ];

    const map = L.map('map', { zoomControl: false }).setView([-6.28, 106.81], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.4 }).addTo(map);
    const analysisLayer = L.layerGroup().addTo(map);

    const stationPts = STASIUN_FIXED.map(s => {
        const m = L.circleMarker([s.lat, s.lng], { radius: 5, fillColor: 'red', color: '#fff', fillOpacity: 1 }).addTo(map);
        m.bindTooltip(s.n, { permanent: true, className: 'label-stasiun', direction: 'top' });
        return turf.point([s.lng, s.lat], { name: s.n });
    });

    document.getElementById('fileInput').onchange = function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(ev) {
            let catchmentGeoJSON;
            const content = ev.target.result;

            if (file.name.endsWith('.kml')) {
                const parser = new DOMParser();
                const kml = parser.parseFromString(content, "text/xml");
                catchmentGeoJSON = toGeoJSON.kml(kml);
            } else {
                catchmentGeoJSON = JSON.parse(content);
            }
            
            processSpatial(catchmentGeoJSON);
        };
        reader.readAsText(file);
    };

    function processSpatial(geojson) {
        analysisLayer.clearLayers();
        
        let feature = geojson.features ? geojson.features[0] : (geojson.geometries ? {geometry: geojson.geometries[0]} : {geometry: geojson});
        let geom = feature.geometry;

        // Deteksi sistem koordinat (UTM atau WGS84)
        // Jika angka koordinat > 180, berasumsi itu UTM
        let firstCoord = (geom.type === 'Polygon') ? geom.coordinates[0][0] : geom.coordinates[0][0][0];
        
        if (Math.abs(firstCoord[0]) > 180) {
            const utmProj = "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs";
            const wgsProj = "+proj=longlat +datum=WGS84 +no_defs";
            
            geom.coordinates = geom.coordinates.map(ring => ring.map(c => {
                let p = proj4(utmProj, wgsProj, [c[0], c[1]]);
                return [p[0], p[1]];
            }));
        }

        const dasPoly = turf.polygon(geom.coordinates);
        L.geoJSON(dasPoly, { style: { color: '#0ea5e9', weight: 3, fillOpacity: 0.1 } }).addTo(analysisLayer);
        map.fitBounds(L.geoJSON(dasPoly).getBounds());

        const bbox = turf.bbox(dasPoly);
        const voronoi = turf.voronoi(turf.featureCollection(stationPts), { bbox: [bbox[0]-1, bbox[1]-1, bbox[2]+1, bbox[3]+1] });

        let totalLuas = 0;
        let hasil = [];

        voronoi.features.forEach((v, i) => {
            const intersect = turf.intersect(v, dasPoly);
            if (intersect) {
                const luas = turf.area(intersect) / 10000;
                hasil.push({ nama: STASIUN_FIXED[i].n, luas: luas });
                totalLuas += luas;
                L.geoJSON(intersect, { style: { color: '#f59e0b', weight: 1.5, fillOpacity: 0.3 } }).addTo(analysisLayer);
            }
        });

        const tbody = document.getElementById('table-body');
        tbody.innerHTML = "";
        hasil.forEach(h => {
            tbody.innerHTML += `<tr><td>${h.nama}</td><td>${h.luas.toFixed(2)}</td><td>${(h.luas/totalLuas).toFixed(4)}</td></tr>`;
        });
        document.getElementById('output-box').style.display = 'block';
    }
</script>
</body>
</html>
