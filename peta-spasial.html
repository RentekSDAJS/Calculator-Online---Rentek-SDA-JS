<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS | ANALISIS HIDROLOGI LENGKAP</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <style>
        :root { --main: #1e293b; --blue: #2563eb; --green: #059669; --orange: #ea580c; --red: #dc2626; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        #map { flex: 2; z-index: 1; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 12px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; }
        h3 { font-size: 12px; text-transform: uppercase; color: #64748b; margin-top: 0; border-bottom: 2px solid #e2e8f0; padding-bottom: 5px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #f1f5f9; padding: 6px; border: 1px solid #cbd5e1; }
        td { padding: 6px; border: 1px solid #e2e8f0; text-align: center; }
        .pass-5 { color: var(--green); font-weight: bold; }
        .pass-1 { color: var(--orange); font-weight: bold; }
        .fail { color: var(--red); font-weight: bold; }
        .best-badge { background: var(--green); color: white; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2 style="margin-top:0; color:var(--main);">HYDRO-EXPERT ANALYTICS</h2>
    <div class="card">
        <h3>1. UPLOAD AREA (JSON)</h3>
        <button class="upload-btn" onclick="document.getElementById('fIn').value=''; document.getElementById('fIn').click()">PILIH FILE DAS</button>
        <input type="file" id="fIn" style="display:none" accept=".json">
    </div>

    <div id="resThiessen" class="card" style="display:none">
        <h3>2. ANALISIS LUAS PENGARUH (THIESSEN)</h3>
        <table>
            <thead><tr><th>Stasiun</th><th>Luas (km²)</th><th>Bobot (W)</th></tr></thead>
            <tbody id="tBody"></tbody>
        </table>
    </div>

    <div id="resRain" class="card" style="display:none">
        <h3>3. HUJAN RERATA DAS (mm)</h3>
        <table><thead><tr><th>Tahun</th><th>P-Rerata</th></tr></thead><tbody id="rBody"></tbody></table>
    </div>
    <div id="resFreq" class="card" style="display:none">
        <h3>4. HUJAN RANCANGAN (Kala Ulang)</h3>
        <table><thead><tr><th>T (Th)</th><th>Normal</th><th>Log-N</th><th>Gumbel</th><th>LP-III</th></tr></thead><tbody id="fBody"></tbody></table>
    </div>
    <div id="resTest" class="card" style="display:none">
        <h3>5. UJI KECOCOKAN (Status Multi-Level)</h3>
        <table>
            <thead>
                <tr>
                    <th>Metode</th>
                    <th>Δ Max</th>
                    <th>Status S-K</th>
                    <th>χ² (Chi)</th>
                    <th>Status Chi</th>
                    <th>Hasil</th>
                </tr>
            </thead>
            <tbody id="vBody"></tbody>
        </table>
        <div id="bestMethod"></div>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    const map = L.map('map').setView([-6.20, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { opacity: 0.5 }).addTo(map);
    let analysisLayer = L.layerGroup().addTo(map);

    // Load DB dari localStorage
    const db = JSON.parse(localStorage.getItem('sda_db_final_clean')) || {};

    document.getElementById('fIn').onchange = function(e) {
        const reader = new FileReader();
        reader.onload = (ev) => processHydrology(JSON.parse(ev.target.result));
        reader.readAsText(e.target.files[0]);
    };

    function processHydrology(json) {
        analysisLayer.clearLayers();
        document.getElementById('tBody').innerHTML = ""; // Reset Thiessen
        document.getElementById('rBody').innerHTML = "";
        document.getElementById('fBody').innerHTML = "";
        document.getElementById('vBody').innerHTML = "";

        // 1. Plot Titik Stasiun Hujan ke Peta
        Object.keys(db).forEach(id => {
            L.circleMarker([db[id].lat, db[id].lng], {
                radius: 6, color: 'blue', fillColor: 'white', fillOpacity: 1
            }).addTo(analysisLayer).bindPopup(`<b>Stasiun: ${id}</b>`);
        });

        // 2. Gabungkan Area DAS
        let feats = json.features || (json.geometries ? json.geometries.map(g => ({type:"Feature", geometry:g})) : [json]);
        let mergedDAS;
        feats.forEach(f => {
            const fix = (coords) => coords.map(c => Array.isArray(c[0]) ? fix(c) : (c[0] > 1000 ? proj4("EPSG:32748", "WGS84", c) : c));
            f.geometry.coordinates = fix(f.geometry.coordinates);
            mergedDAS = mergedDAS ? turf.union(mergedDAS, f) : f;
        });
        L.geoJSON(mergedDAS, {style:{color:'red', weight:2, fillOpacity:0.1}}).addTo(analysisLayer);
        map.fitBounds(L.geoJSON(mergedDAS).getBounds());

        // 3. Hitung Thiessen & Luas Pengaruh
        const pts = turf.featureCollection(Object.keys(db).map(id => turf.point([db[id].lng, db[id].lat], {id: id})));
        const voronoi = turf.voronoi(pts, {bbox: turf.bbox(mergedDAS)});
        let thiessenResults = [], totalArea = 0;

        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, mergedDAS);
            if (clip) {
                const area = turf.area(clip) / 1000000;
                totalArea += area;
                const id = pts.features[i].properties.id;
                thiessenResults.push({ id, area });
                
                // Gambar Poligon Thiessen Terpotong
                L.geoJSON(clip, {style:{color:'white', weight:1, fillColor:'blue', fillOpacity:0.2}}).addTo(analysisLayer);
            }
        });

        // 4. Isi Tabel Thiessen dan Hitung Hujan Rerata
        let rainSeries = [];
        const thnCount = db[Object.keys(db)[0]].d.length;

        thiessenResults.forEach(res => {
            const w = res.area / totalArea;
            document.getElementById('tBody').innerHTML += `<tr><td>${res.id}</td><td>${res.area.toFixed(2)}</td><td>${w.toFixed(4)}</td></tr>`;
            res.w = w;
        });

        for (let t = 0; t < thnCount; t++) {
            let pAvg = 0;
            thiessenResults.forEach(res => { pAvg += (db[res.id].d[t] * res.w); });
            rainSeries.push(pAvg);
            document.getElementById('rBody').innerHTML += `<tr><td>200${t}</td><td>${pAvg.toFixed(2)}</td></tr>`;
        }

        runFrequencyAnalysis(rainSeries);
        
        // Tampilkan semua Card
        ['resThiessen', 'resRain', 'resFreq', 'resTest'].forEach(id => document.getElementById(id).style.display = 'block');
    }

    function runFrequencyAnalysis(data) {
        const n = data.length;
        const mean = data.reduce((a, b) => a + b) / n;
        const stdDev = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        const logData = data.map(x => Math.log10(x));
        const logMean = logData.reduce((a, b) => a + b) / n;
        const logStdDev = Math.sqrt(logData.map(x => Math.pow(x - logMean, 2)).reduce((a, b) => a + b) / (n - 1));
        const logSkew = n * logData.map(x => Math.pow(x - logMean, 3)).reduce((a, b) => a + b) / ((n - 1) * (n - 2) * Math.pow(logStdDev, 3));

        const T = [2, 5, 10, 25, 50, 100];
        let mStats = { Normal:[], LogN:[], Gumbel:[], LP3:[] };

        T.forEach(t => {
            const z = { 2:0, 5:0.842, 10:1.282, 25:1.751, 50:2.054, 100:2.326 }[t];
            const rN = mean + (z * stdDev);
            const rLN = Math.pow(10, logMean + (z * logStdDev));
            const rG = mean + (((-(Math.log(Math.log(t/(t-1)))) - 0.5128)/1.1004) * stdDev);
            const rLP = Math.pow(10, logMean + (((2/logSkew) * (Math.pow(((z - logSkew/6) * logSkew/6 + 1), 3) - 1)) * logStdDev));
            
            mStats.Normal.push(rN); mStats.LogN.push(rLN); mStats.Gumbel.push(rG); mStats.LP3.push(rLP);
            document.getElementById('fBody').innerHTML += `<tr><td><b>${t}</b></td><td>${rN.toFixed(1)}</td><td>${rLN.toFixed(1)}</td><td>${rG.toFixed(1)}</td><td style="color:var(--blue); font-weight:bold">${rLP.toFixed(1)}</td></tr>`;
        });

        // --- UJI KECOCOKAN MULTI-LEVEL ---
        const sortedData = [...data].sort((a,b) => b-a);
        const critSK5 = 1.36 / Math.sqrt(n); 
        const critSK1 = 1.63 / Math.sqrt(n);
        const critChi5 = 5.99;
        const critChi1 = 9.21;
        let validMethods = [];

        ['Normal','LogN','Gumbel','LP3'].forEach(m => {
            let dMax = 0;
            sortedData.forEach((v, i) => {
                const pObs = (i + 1) / (n + 1);
                const pTeo = 0.5; // Aproksimasi teoritis
                dMax = Math.max(dMax, Math.abs(pObs - pTeo));
            });
            const x2 = Math.pow((mean - mStats[m][0]), 2) / mean; 

            // Status S-K
            let skStat = "Ditolak", skCls = "fail";
            if (dMax < critSK5) { skStat = "Diterima 5%"; skCls = "pass-5"; }
            else if (dMax < critSK1) { skStat = "Diterima 1%"; skCls = "pass-1"; }

            // Status Chi
            let chiStat = "Ditolak", chiCls = "fail";
            if (x2 < critChi5) { chiStat = "Diterima 5%"; chiCls = "pass-5"; }
            else if (x2 < critChi1) { chiStat = "Diterima 1%"; chiCls = "pass-1"; }

            const ok = skStat !== "Ditolak" && chiStat !== "Ditolak";

            document.getElementById('vBody').innerHTML += `
                <tr>
                    <td><b>${m}</b></td>
                    <td>${dMax.toFixed(3)}</td><td class="${skCls}">${skStat}</td>
                    <td>${x2.toFixed(3)}</td><td class="${chiCls}">${chiStat}</td>
                    <td>${ok?'✅':'❌'}</td>
                </tr>`;
            
            if(ok) validMethods.push({name: m, score: dMax + x2, level: skStat});
        });

        const bEl = document.getElementById('bestMethod');
        if(validMethods.length > 0) {
            const best = validMethods.sort((a,b) => a.score - b.score)[0];
            bEl.className = "best-badge";
            bEl.style.background = best.level.includes("5%") ? "var(--green)" : "var(--orange)";
            bEl.innerHTML = `HASIL ANALISIS: METODE ${best.name.toUpperCase()} (${best.level})`;
        } else {
            bEl.className = "";
            bEl.innerHTML = "<small style='color:var(--red)'>⚠️ Data tidak lolos uji. Tetap gunakan LP-III sesuai standar PU.</small>";
        }
    }
</script>
</body>
</html>
