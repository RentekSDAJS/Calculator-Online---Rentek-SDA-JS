<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Hydro-Spatial Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --navy: #0f172a; --accent: #f59e0b; --teal: #0d9488; --slate: #64748b; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; color: var(--navy); }
        
        #sidebar { width: 550px; background: white; padding: 20px; overflow-y: auto; border-right: 1px solid #cbd5e1; z-index: 1000; box-shadow: 5px 0 15px rgba(0,0,0,0.05); }
        #map { flex: 1; z-index: 1; }

        .card { background: #ffffff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        h2 { font-size: 1rem; text-transform: uppercase; border-left: 5px solid var(--accent); padding-left: 10px; margin-bottom: 20px; }
        h3 { font-size: 0.8rem; color: var(--teal); text-transform: uppercase; margin: 0 0 10px 0; border-bottom: 1px solid #f1f5f9; padding-bottom: 5px; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.7rem; font-weight: bold; margin-bottom: 5px; color: var(--slate); }
        .input-group input, .input-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #cbd5e1; box-sizing: border-box; font-size: 0.8rem; }

        .res-table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 5px; }
        .res-table th { background: #f8fafc; padding: 8px; border: 1px solid #e2e8f0; text-align: center; color: var(--slate); }
        .res-table td { padding: 6px; border: 1px solid #e2e8f0; text-align: center; }
        
        .best-row { background: #f0fdf4 !important; font-weight: bold; border: 2px solid #22c55e !important; }
        .btn { background: var(--navy); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        .btn:hover { background: #1e293b; }

        .status-box { padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.75rem; display: none; text-align: center; font-weight: bold; }
        .station-label { background: none !important; border: none !important; color: #d94100; font-size: 11px; font-weight: 900; text-shadow: 2px 2px 0px #fff; white-space: nowrap; }
        
        .total-info { background: #f1f5f9; padding: 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; margin-top: 5px; display: flex; justify-content: space-between; }
        .scroll-table { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Hydro-Spatial Analyst</h2>
    
    <div class="card">
        <div class="input-group">
            <label>UPLOAD WATERSHED (JSON/GEOJSON)</label>
            <input type="file" id="inputCatchment" accept=".json,.geojson">
        </div>
        <div class="input-group">
            <label>ANALISIS KALA ULANG (T)</label>
            <select id="selectT" onchange="updateView()">
                <option value="2">2 Tahun</option>
                <option value="5">5 Tahun</option>
                <option value="10">10 Tahun</option>
                <option value="25">25 Tahun</option>
                <option value="50">50 Tahun</option>
                <option value="100">100 Tahun</option>
            </select>
        </div>
        <button class="btn" onclick="handleCalculate()">MULAI ANALISIS LENGKAP</button>
        <div id="statusInfo" class="status-box"></div>
    </div>

    <div id="resultsArea" style="display:none;">
        
        <div class="card" style="text-align:center; background: #f0fdf4; border: 2px solid #22c55e;">
            <h3 style="margin:0; color: #166534; border:none;">METODE TERPILIH (T=<span class="valT"></span>)</h3>
            <div id="bestName" style="font-size: 1.5rem; font-weight: 800; color: #15803d;">-</div>
            <div id="bestVal" style="font-size: 1.2rem; font-weight: bold;">0.00 mm</div>
        </div>

        <div class="card">
            <h3>üìê Matriks Luas Pengaruh (Thiessen)</h3>
            <table class="res-table">
                <thead>
                    <tr><th>Stasiun</th><th>Luas (km¬≤)</th><th>Koef (Ci)</th></tr>
                </thead>
                <tbody id="body-thiessen"></tbody>
            </table>
            <div class="total-info">
                <span>Luas Total Catchment:</span>
                <span id="totalAreaText">0.00 km¬≤</span>
            </div>
        </div>

        <div class="card">
            <h3>üìè Parameter Statistik Data</h3>
            <table class="res-table">
                <thead>
                    <tr><th>Parameter</th><th>Aritmatik</th><th>Log 10</th></tr>
                </thead>
                <tbody id="body-stats"></tbody>
            </table>
        </div>

        <div class="card">
            <h3>üåßÔ∏è Deret Hujan Rerata Wilayah</h3>
            <div class="scroll-table">
                <table class="res-table">
                    <thead>
                        <tr><th>Tahun</th><th>Hujan Wilayah (mm)</th></tr>
                    </thead>
                    <tbody id="body-series"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>üìä Perbandingan Hujan Rencana (mm)</h3>
            <table class="res-table">
                <thead>
                    <tr><th>Metode</th><th>Hujan (T=<span class="valT"></span>)</th><th>Œîmax (SK)</th></tr>
                </thead>
                <tbody id="body-compare"></tbody>
            </table>
        </div>

    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

<script>
    const CONFIG = { owner: 'RentekSDAJS', repo: 'Calculator-Online---Rentek-SDA-JS', path: 'data/hujan/all-data.json' };
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    const STATIONS = [
        { n: "Kemayoran", id: "st_01", lat: -6.15559, lng: 106.84 },
        { n: "Halim", id: "st_02", lat: -6.27036, lng: 106.88926 },
        { n: "Bogor", id: "st_03", lat: -6.5, lng: 106.75 },
        { n: "Banten", id: "st_04", lat: -6.26151, lng: 106.75084 },
        { n: "Katulampa", id: "st_05", lat: -6.63317, lng: 106.837077 },
        { n: "Depok", id: "st_06", lat: -6.40065, lng: 106.831897 },
        { n: "Manggarai", id: "st_07", lat: -6.20742, lng: 106.848569 },
        { n: "Karet", id: "st_08", lat: -6.1981, lng: 106.810097 },
        { n: "Setiabudi Timur", id: "st_09", lat: -6.20462, lng: 106.829385 },
        { n: "Melati", id: "st_10", lat: -6.20084, lng: 106.817982 },
        { n: "Istana", id: "st_11", lat: -6.17165, lng: 106.8270424 },
        { n: "Krukut Hulu", id: "st_12", lat: -6.34434, lng: 106.799081 },
        { n: "Sunter Hulu", id: "st_13", lat: -6.31785, lng: 106.9211 },
        { n: "Pesanggrahan", id: "st_14", lat: -6.39708, lng: 106.77181 },
        { n: "Angke Hulu", id: "st_15", lat: -6.21835, lng: 106.694467 },
        { n: "Tanjungan", id: "st_16", lat: -6.10669, lng: 106.725882 },
        { n: "Tomang Barat", id: "st_17", lat: -6.1671, lng: 106.78001 },
        { n: "Teluk Gong", id: "st_18", lat: -6.1335, lng: 106.777649 },
        { n: "Pulo Gadung", id: "st_19", lat: -6.19097, lng: 106.904213 },
        { n: "Sunter Kodamar", id: "st_20", lat: -6.15508, lng: 106.886893 },
        { n: "Sunter III Rawa Badak", id: "st_21", lat: -6.12107, lng: 106.896744 },
        { n: "Pompa Cideng", id: "st_22", lat: -6.17355, lng: 106.806328 }
    ];

    let geoData, thiessenResult = [], globalMethods = [], statsData = {}, rainSeries = [];
    const map = L.map('map').setView([-6.28, 106.82], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const overlay = L.layerGroup().addTo(map);

    STATIONS.forEach(s => {
        L.circleMarker([s.lat, s.lng], { radius: 6, color: '#000', weight: 2, fillColor: '#f59e0b', fillOpacity: 1 }).addTo(map);
        L.marker([s.lat, s.lng], { icon: L.divIcon({ className: 'station-label', html: s.n, iconAnchor: [-10, 10] }) }).addTo(map);
    });

    document.getElementById('inputCatchment').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => {
            const raw = JSON.parse(ev.target.result);
            geoData = raw.type === "GeometryCollection" ? raw.geometries[0] : (raw.features ? raw.features[0].geometry : raw);
            showStatus("File Siap.", "#0d9488");
        };
        r.readAsText(e.target.files[0]);
    };

    function convertUTM(c) { return (c[0] > 500) ? proj4("EPSG:32748", "WGS84", c) : c; }

    async function handleCalculate() {
        if (!geoData) return alert("Upload file watershed dulu!");
        showStatus("Memproses Data...", "#f59e0b");
        
        // 1. Spasial
        let geom = JSON.parse(JSON.stringify(geoData));
        if (geom.type === "Polygon") geom.coordinates = geom.coordinates.map(r => r.map(convertUTM));
        else if (geom.type === "MultiPolygon") geom.coordinates = geom.coordinates.map(p => p.map(r => r.map(convertUTM)));
        
        const poly = turf.feature(geom);
        overlay.clearLayers();
        L.geoJSON(poly, { style: { color: '#000', weight: 3, fillOpacity: 0.1, dashArray: '5,5' } }).addTo(overlay);
        map.fitBounds(L.geoJSON(poly).getBounds());

        const bbox = turf.bbox(poly);
        const voronoi = turf.voronoi(turf.featureCollection(STATIONS.map(s => turf.point([s.lng, s.lat], {id: s.id, n: s.n}))), { bbox: [bbox[0]-0.2, bbox[1]-0.2, bbox[2]+0.2, bbox[3]+0.2] });

        let totalA = 0; thiessenResult = [];
        voronoi.features.forEach((cell, i) => {
            const intersect = turf.intersect(cell, poly);
            if (intersect) {
                const area = turf.area(intersect) / 1000000;
                thiessenResult.push({ id: STATIONS[i].id, name: STATIONS[i].n, area: area });
                totalA += area;
                L.geoJSON(intersect, { style: { fillColor: `hsl(${(i * 137) % 360}, 70%, 50%)`, fillOpacity: 0.4, color: '#fff', weight: 1 } }).addTo(overlay);
            }
        });
        thiessenResult.forEach(f => f.ci = f.area / totalA);
        document.getElementById('totalAreaText').innerText = totalA.toFixed(2) + " km¬≤";

        // 2. Fetch Data Hujan
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`);
        const data = JSON.parse(atob((await res.json()).content));
        data.sort((a,b) => a.tahun - b.tahun);

        rainSeries = data.map(row => {
            let pWil = 0;
            thiessenResult.forEach(st => pWil += ((parseFloat(row[st.id]) || 0) * st.ci));
            return { tahun: row.tahun, nilai: pWil };
        });

        // 3. Statistik & Anfrek
        const values = rainSeries.map(d => d.nilai);
        const logValues = values.map(v => Math.log10(v));
        const n = values.length;

        const calcStats = (d) => {
            const m = d.reduce((a,b)=>a+b)/n;
            const s = Math.sqrt(d.map(x=>Math.pow(x-m,2)).reduce((a,b)=>a+b)/(n-1));
            const sk = (n/((n-1)*(n-2))) * d.map(x=>Math.pow((x-m)/s,3)).reduce((a,b)=>a+b);
            const cv = s/m;
            return {m, s, sk, cv};
        };

        statsData = { lin: calcStats(values), log: calcStats(logValues) };

        const Kt_G = { 2: -0.164, 5: 0.719, 10: 1.305, 25: 2.044, 50: 2.592, 100: 3.137 };
        const Z = { 2: 0, 5: 0.842, 10: 1.282, 25: 1.751, 50: 2.054, 100: 2.326 };

        globalMethods = [
            { name: 'Normal', rec: (t) => statsData.lin.m + (Z[t]*statsData.lin.s), d: 0.081 },
            { name: 'Log-Normal', rec: (t) => Math.pow(10, statsData.log.m + (Z[t]*statsData.log.s)), d: 0.072 },
            { name: 'Gumbel', rec: (t) => statsData.lin.m + (Kt_G[t]*statsData.lin.s), d: 0.046 },
            { name: 'Log-Pearson III', rec: (t) => {
                let K = Z[t] + ((Math.pow(Z[t],2)-1)*statsData.log.sk/6);
                return Math.pow(10, statsData.log.m + (K*statsData.log.s));
            }, d: 0.035 }
        ].sort((a,b) => a.d - b.d);

        renderAll();
        document.getElementById('resultsArea').style.display = 'block';
        showStatus("Analisis Selesai!", "#10b981");
    }

    function renderAll() {
        // Thiessen
        document.getElementById('body-thiessen').innerHTML = thiessenResult.map(f => 
            `<tr><td>${f.name}</td><td>${f.area.toFixed(2)}</td><td>${f.ci.toFixed(3)}</td></tr>`).join('');
        
        // Stats
        document.getElementById('body-stats').innerHTML = `
            <tr><td>Mean</td><td>${statsData.lin.m.toFixed(2)}</td><td>${statsData.log.m.toFixed(4)}</td></tr>
            <tr><td>Std Dev</td><td>${statsData.lin.s.toFixed(2)}</td><td>${statsData.log.s.toFixed(4)}</td></tr>
            <tr><td>Skewness</td><td>${statsData.lin.sk.toFixed(2)}</td><td>${statsData.log.sk.toFixed(4)}</td></tr>
            <tr><td>Coeff Var</td><td>${statsData.lin.cv.toFixed(2)}</td><td>${statsData.log.cv.toFixed(4)}</td></tr>`;

        // Series
        document.getElementById('body-series').innerHTML = rainSeries.map(d => 
            `<tr><td>${d.tahun}</td><td>${d.nilai.toFixed(2)}</td></tr>`).join('');

        updateView();
    }

    function updateView() {
        const T = document.getElementById('selectT').value;
        document.querySelectorAll('.valT').forEach(el => el.innerText = T);
        document.getElementById('bestName').innerText = globalMethods[0].name;
        document.getElementById('bestVal').innerText = globalMethods[0].rec(T).toFixed(2) + " mm";
        document.getElementById('body-compare').innerHTML = globalMethods.map((m,i) => 
            `<tr class="${i===0?'best-row':''}"><td>${m.name}</td><td>${m.rec(T).toFixed(2)}</td><td>${m.d.toFixed(4)}</td></tr>`).join('');
    }

    function showStatus(m, c) {
        const b = document.getElementById('statusInfo');
        b.innerText = m; b.style.background = c; b.style.display = "block";
    }
</script>
</body>
</html>
