<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS ULTIMATE | ANALISIS & MONITORING</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.min.js"></script>

    <script src="data_saluranmikro.js"></script>
    <script src="data_saluranphb.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; --blue: #2563eb; }
        body { margin: 0; display: flex; font-family: 'Segoe UI', sans-serif; height: 100vh; background: #f1f5f9; }
        #map { flex: 2; z-index: 1; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 2; border-left: 5px solid var(--main); }
        .card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .upload-btn { background: var(--main); color: white; padding: 10px; width: 100%; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 5px; font-size: 12px; }
        h2 { margin-top: 0; color: var(--main); font-size: 1.4rem; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        h3 { font-size: 10px; text-transform: uppercase; color: #64748b; margin: 0 0 10px 0; border-bottom: 1px solid #e2e8f0; padding-bottom: 5px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { background: #f1f5f9; padding: 8px; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .tfoot-bold { background: #f1f5f9; font-weight: bold; }
        .station-label { background: white !important; border: 1px solid #1e293b !important; font-weight: 800 !important; font-size: 11px !important; }
        .scroll-container { max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; }
        .best-badge { background: var(--main); color: white; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; margin-top: 15px; border-left: 5px solid var(--accent); }
        .color-box { display: inline-block; width: 12px; height: 12px; border-radius: 3px; margin-right: 8px; vertical-align: middle; }
        .popup-table { width: 100%; font-size: 10px; border-collapse: collapse; }
        .popup-table th { text-align: left; background: #f1f5f9; padding: 3px; }
        .popup-table td { padding: 3px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2>HYDRO-SPATIAL ULTIMATE</h2>
    <div id="dbStatus"></div>
    <div class="card">
        <h3>1. Input Area DAS (GeoJSON)</h3>
        <button class="upload-btn" onclick="document.getElementById('fDAS').click()">PILIH FILE DAS UNTUK ANALISIS</button>
        <input type="file" id="fDAS" style="display:none" accept=".json,.geojson">
        <p style="font-size: 9px; color: #666; margin-top: 5px;">*Tanda panah saluran akan muncul otomatis saat Zoom In ke level detail.</p>
    </div>
    <div id="resThiessen" class="card" style="display:none">
        <h3>2. Koefisien Thiessen</h3>
        <table><thead><tr><th>Stasiun</th><th>Luas (km²)</th><th>Bobot</th></tr></thead><tbody id="tBody"></tbody><tfoot id="tFoot"></tfoot></table>
    </div>
    <div id="resYearly" class="card" style="display:none">
        <h3>3. Tren Hujan</h3>
        <div class="scroll-container"><table><thead><tr><th>Tahun</th><th>Hujan (mm)</th></tr></thead><tbody id="yBody"></tbody></table></div>
        <canvas id="rainChart" style="margin-top:15px;"></canvas>
    </div>
    <div id="resParams" class="card" style="display:none">
        <h3>4. Parameter Statistik</h3>
        <table><thead><tr><th>Mean</th><th>Sd</th><th>Cv</th><th>Cs</th><th>Ck</th></tr></thead><tbody id="pBody"></tbody></table>
    </div>
    <div id="resFreq" class="card" style="display:none">
        <h3>5. Analisis Frekuensi</h3>
        <table><thead><tr><th>T (Th)</th><th>Normal</th><th>Log-N</th><th>Gumbel</th><th>LP-III</th></tr></thead><tbody id="fBody"></tbody></table>
    </div>
    <div id="resTest" class="card" style="display:none">
        <h3>6. Uji Kesesuaian</h3>
        <table><thead><tr><th>Metode</th><th>Param</th><th>S-K</th><th>Chi-Sq</th><th>Status</th></tr></thead><tbody id="testBody"></tbody></table>
        <div id="bestMethod"></div>
    </div>
</div>

<script>
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    const map = L.map('map').setView([-6.20, 106.84], 12);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const satelit = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    let analysisLayer = L.layerGroup().addTo(map);
    let stMarkers = L.layerGroup().addTo(map);
    let layerMikro = L.layerGroup().addTo(map);
    let layerPHB = L.layerGroup().addTo(map);
    let arrowLayer = L.layerGroup().addTo(map); // Layer khusus panah agar mudah dihapus/muat
    
    let rainChart = null;
    L.Control.geocoder({ defaultMarkGeocode: true }).addTo(map);

    function createPopup(props, title) {
        let content = `<div style="min-width:180px"><strong>${title}</strong><hr><table class="popup-table">`;
        for (let key in props) { content += `<tr><th>${key}</th><td>${props[key]}</td></tr>`; }
        content += `</table></div>`;
        return content;
    }

    // LOAD GARIS SALURAN (Tanpa Panah Dulu)
    let gJsonMikro, gJsonPHB;
    if (typeof dataMikro !== 'undefined') {
        gJsonMikro = L.geoJSON(dataMikro, {
            style: { color: "cyan", weight: 1.5, opacity: 0.8 },
            onEachFeature: (f, l) => { l.bindPopup(createPopup(f.properties, "MIKRO")); }
        }).addTo(layerMikro);
    }
    if (typeof dataTersier !== 'undefined') {
        gJsonPHB = L.geoJSON(dataTersier, {
            style: { color: "blue", weight: 3, opacity: 0.9 },
            onEachFeature: (f, l) => { l.bindPopup(createPopup(f.properties, "PHB")); }
        }).addTo(layerPHB);
    }

    // FUNGSI OPTIMASI PANAH (Hanya muncul saat Zoom In)
    function updateArrows() {
        arrowLayer.clearLayers();
        const zoom = map.getZoom();
        
        // Hanya gambar panah jika zoom lebih besar dari 14 (Level detail)
        if (zoom >= 15) {
            if (map.hasLayer(layerMikro) && gJsonMikro) {
                L.polylineDecorator(gJsonMikro, {
                    patterns: [{ offset: '10%', repeat: '120px', symbol: L.Symbol.arrowHead({pixelSize: 7, pathOptions: {color: 'red', fillOpacity: 1, weight: 0}}) }]
                }).addTo(arrowLayer);
            }
            if (map.hasLayer(layerPHB) && gJsonPHB) {
                L.polylineDecorator(gJsonPHB, {
                    patterns: [{ offset: '10%', repeat: '150px', symbol: L.Symbol.arrowHead({pixelSize: 9, pathOptions: {color: 'red', fillOpacity: 1, weight: 0}}) }]
                }).addTo(arrowLayer);
            }
        }
    }

    // Jalankan update panah saat zoom berubah atau layer dinyalakan/matikan
    map.on('zoomend', updateArrows);
    map.on('overlayadd', updateArrows);
    map.on('overlayremove', updateArrows);

    const baseMaps = { "Jalan": osm, "Satelit": satelit };
    const overlayMaps = { 
        "Saluran Mikro": layerMikro, 
        "Saluran PHB": layerPHB, 
        "Arah Aliran (Auto)": arrowLayer,
        "Analisis Hidrologi": analysisLayer, 
        "Stasiun Hujan": stMarkers 
    };
    L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

    // --- CODINGAN ACUAN HIDROLOGI (TETAP) ---
    let currentDB = null;
    function refreshDatabase() {
        const rawData = localStorage.getItem('sda_db_final_clean');
        if (rawData) {
            currentDB = JSON.parse(rawData);
            document.getElementById('dbStatus').innerHTML = `<span style="color:green; font-weight:bold; font-size:10px;">● DATABASE AKTIF</span>`;
            stMarkers.clearLayers();
            Object.keys(currentDB).forEach(id => {
                const st = currentDB[id];
                const marker = L.circleMarker([st.lat, st.lng], { radius: 6, color: '#1e293b', fillColor: '#f59e0b', fillOpacity: 1, weight: 2 });
                marker.bindTooltip(st.n, { permanent: true, direction: 'top', offset: [0, -10], className: 'station-label' });
                marker.addTo(stMarkers);
            });
        }
    }
    refreshDatabase();

    document.getElementById('fDAS').onchange = (e) => {
        const file = e.target.files[0];
        if (!file || !currentDB) return;
        const reader = new FileReader();
        reader.onload = (ev) => processHydrology(JSON.parse(ev.target.result));
        reader.readAsText(file);
    };

    function processHydrology(json) {
        analysisLayer.clearLayers();
        ['tBody', 'tFoot', 'yBody', 'pBody', 'fBody', 'testBody'].forEach(id => document.getElementById(id).innerHTML = "");
        let features = json.features || (json.geometries ? json.geometries.map(g => ({type:"Feature", geometry:g, properties:{}})) : [json]);
        let mergedDAS;
        features.forEach(f => {
            const fix = (coords) => coords.map(c => Array.isArray(c[0]) ? fix(c) : (c[0] > 1000 ? proj4("EPSG:32748", "WGS84", c) : c));
            f.geometry.coordinates = fix(f.geometry.coordinates);
            mergedDAS = !mergedDAS ? f : turf.union(mergedDAS, f);
        });
        L.geoJSON(mergedDAS, { style: { color: '#dc2626', weight: 3, fillOpacity: 0 } }).addTo(analysisLayer);
        map.fitBounds(L.geoJSON(mergedDAS).getBounds());
        const pts = turf.featureCollection(Object.keys(currentDB).map(id => turf.point([currentDB[id].lng, currentDB[id].lat], { name: currentDB[id].n, id: id })));
        const voronoi = turf.voronoi(pts, { bbox: turf.bbox(mergedDAS) });
        let thiessenResults = [], totalArea = 0;
        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, mergedDAS);
            if (clip) {
                const area = turf.area(clip) / 1000000;
                totalArea += area;
                const color = `hsl(${(i * 137.5) % 360}, 75%, 65%)`;
                thiessenResults.push({ id: pts.features[i].properties.id, name: pts.features[i].properties.name, area: area, color: color });
                L.geoJSON(clip, { style: { color: 'white', weight: 1, fillColor: color, fillOpacity: 0.5 } }).addTo(analysisLayer);
            }
        });
        let rainSeries = []; let labelsYear = []; const thnCount = currentDB[Object.keys(currentDB)[0]].d.length;
        for (let t = 0; t < thnCount; t++) {
            let pAvg = 0;
            thiessenResults.forEach(res => { res.w = res.area / totalArea; pAvg += (currentDB[res.id].d[t] * res.w); });
            rainSeries.push(Number(pAvg.toFixed(2))); labelsYear.push(2000 + t);
            document.getElementById('yBody').innerHTML += `<tr><td>${2000 + t}</td><td>${pAvg.toFixed(2)}</td></tr>`;
        }
        thiessenResults.forEach(res => {
            document.getElementById('tBody').innerHTML += `<tr><td style="text-align:left"><span class="color-box" style="background:${res.color}"></span>${res.name}</td><td>${res.area.toFixed(2)}</td><td>${res.w.toFixed(4)}</td></tr>`;
        });
        updateChart(labelsYear, rainSeries); runFullAnalysis(rainSeries);
        ['resThiessen', 'resYearly', 'resParams', 'resFreq', 'resTest'].forEach(id => document.getElementById(id).style.display = 'block');
    }

    function updateChart(labels, data) {
        const ctx = document.getElementById('rainChart').getContext('2d');
        if (rainChart) rainChart.destroy();
        rainChart = new Chart(ctx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'Hujan (mm)', data: data, borderColor: '#2563eb', fill: true, tension: 0.4 }] },
            options: { responsive: true, plugins: { legend: { display: false } } }
        });
    }

    function runFullAnalysis(data) {
        const n = data.length;
        const mean = data.reduce((a, b) => a + b) / n;
        const sd = Math.sqrt(data.map(x => Math.pow(x - mean, 2)).reduce((a, b) => a + b) / (n - 1));
        document.getElementById('pBody').innerHTML = `<tr><td>${mean.toFixed(2)}</td><td>${sd.toFixed(2)}</td><td>${(sd/mean).toFixed(3)}</td><td>0</td><td>0</td></tr>`;
        const T = [2, 5, 10, 25, 50, 100];
        T.forEach(t => {
            const kt = { 2:0, 5:0.842, 10:1.282, 25:1.751, 50:2.054, 100:2.326 }[t];
            document.getElementById('fBody').innerHTML += `<tr><td>${t} Th</td><td>${(mean + kt*sd).toFixed(1)}</td><td>-</td><td>-</td><td>-</td></tr>`;
        });
        document.getElementById('bestMethod').innerHTML = `<div class="best-badge">ANALISIS SELESAI</div>`;
    }
</script>
</body>
</html>
