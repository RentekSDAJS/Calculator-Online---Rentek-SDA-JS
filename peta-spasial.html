<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA WEBGIS | PERHITUNGAN THIESSEN & RERATA</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    
    <style>
        :root { --main: #1e293b; --accent: #f59e0b; }
        body { margin: 0; display: flex; font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        #map { flex: 2; background: #e5e7eb; }
        #panel { flex: 1; padding: 20px; background: white; overflow-y: auto; border-left: 4px solid var(--main); }
        h3 { color: var(--main); border-bottom: 2px solid var(--accent); padding-bottom: 8px; font-size: 16px; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; margin-bottom: 10px; }
        th { background: var(--main); color: white; padding: 8px; text-align: left; }
        td { border: 1px solid #e2e8f0; padding: 6px; }
        .highlight { font-weight: 800; color: #059669; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
    <h2 style="margin-top:0; color:var(--main)">ANALISIS HIDROLOGI</h2>
    
    <h3>1. Luas Pengaruh Stasiun (Thiessen)</h3>
    <table id="thiessenTable">
        <thead>
            <tr><th>Stasiun</th><th>Luas (kmÂ²)</th><th>Bobot (W)</th></tr>
        </thead>
        <tbody id="thiessenBody"></tbody>
    </table>

    <h3>2. Hujan Rerata Wilayah Tahunan</h3>
    <table id="avgRainTable">
        <thead>
            <tr><th>Tahun</th><th>Hujan Wilayah (mm)</th></tr>
        </thead>
        <tbody id="avgRainBody"></tbody>
    </table>
</div>

<script>
    // Konfigurasi Proyeksi UTM 48S (Jakarta/Jawa Barat) ke WGS84
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    const map = L.map('map').setView([-6.2297, 106.8295], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const dbSource = JSON.parse(localStorage.getItem('sda_db_final_clean'));

    async function processThiessen() {
        if (!dbSource) {
            alert("Database portal hujan kosong! SINKRONKAN data dulu di data-hujan.html");
            return;
        }

        try {
            // 1. Load data DAS (Ganti dengan file kamu)
            const res = await fetch('Kali Sunter.json');
            let catchment = await res.json();

            // 2. Konversi UTM ke Lat/Long jika diperlukan
            catchment.features[0].geometry.coordinates[0] = catchment.features[0].geometry.coordinates[0].map(coord => {
                // Jika angka koordinat > 1000, asumsikan itu UTM
                if (coord[0] > 1000) {
                    return proj4("EPSG:32748", "WGS84", coord);
                }
                return coord;
            });

            const catchmentLayer = L.geoJSON(catchment, { style: { color: 'red', weight: 2, fillOpacity: 0.05 } }).addTo(map);

            // 3. Siapkan Titik Stasiun
            const points = turf.featureCollection(
                Object.keys(dbSource).map(id => {
                    const st = dbSource[id];
                    return turf.point([st.lng, st.lat], { name: st.n, id: id });
                })
            );

            // 4. Hitung Poligon Thiessen
            const bbox = turf.bbox(catchment);
            const vPolys = turf.voronoi(points, { bbox: bbox });

            let totalArea = 0;
            let results = [];

            vPolys.features.forEach((poly, i) => {
                const clipped = turf.intersect(poly, catchment.features[0]);
                if (clipped) {
                    const area = turf.area(clipped) / 1000000;
                    const stName = points.features[i].properties.name;
                    const stId = points.features[i].properties.id;
                    totalArea += area;
                    results.push({ id: stId, name: stName, area: area, geo: clipped });
                    
                    L.geoJSON(clipped, { style: { color: '#3b82f6', weight: 1, fillOpacity: 0.2 } })
                     .bindTooltip(stName).addTo(map);
                }
            });

            // 5. Render Tabel Thiessen
            const tBody = document.getElementById('thiessenBody');
            results.forEach(r => {
                const w = r.area / totalArea;
                r.weight = w; // simpan bobot untuk hitungan rerata
                tBody.innerHTML += `<tr><td>${r.name}</td><td>${r.area.toFixed(2)}</td><td>${w.toFixed(4)}</td></tr>`;
            });

            // 6. HITUNG HUJAN RERATA WILAYAH PER TAHUN
            const rBody = document.getElementById('avgRainBody');
            const sampleId = Object.keys(dbSource)[0];
            const tahunCount = dbSource[sampleId].d.length;

            for (let t = 0; t < tahunCount; t++) {
                let rainAvg = 0;
                results.forEach(r => {
                    const rainValue = dbSource[r.id].d[t] || 0;
                    rainAvg += (rainValue * r.weight);
                });

                rBody.innerHTML += `
                    <tr>
                        <td> Tahun ${2000 + t}</td>
                        <td class="highlight">${rainAvg.toFixed(2)} mm</td>
                    </tr>
                `;
            }

            map.fitBounds(catchmentLayer.getBounds());

        } catch (e) {
            console.error(e);
            alert("Pastikan file JSON ada dan formatnya benar.");
        }
    }

    processThiessen();
</script>
</body>
</html>
