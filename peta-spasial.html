<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA HYDRO-ULTIMATE V22 | RE-SYNC LABELS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turf/6.5.0/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.6/jstat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --navy: #0f172a; --gold: #f59e0b; --border: #e2e8f0; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #map { flex: 1; height: 100vh; z-index: 1; }
        .sidebar { width: 700px; background: white; border-left: 5px solid var(--navy); overflow-y: auto; z-index: 1000; box-shadow: -10px 0 20px rgba(0,0,0,0.1); }
        .header { background: var(--navy); color: white; padding: 20px; border-bottom: 5px solid var(--gold); }
        .content { padding: 20px; }
        
        /* LABEL STASIUN KONTRAS */
        .leaflet-tooltip.station-label { 
            background: var(--navy); border: 2px solid var(--gold); color: white; 
            font-weight: 800; font-size: 11px; padding: 4px 8px; border-radius: 6px;
            text-align: center; line-height: 1.2; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .rain-val { color: var(--gold); font-size: 10px; display: block; margin-top: 2px; }

        .btn-kalkulasi { 
            width: 100%; padding: 15px; background: var(--gold); color: var(--navy); 
            border: none; border-radius: 10px; font-weight: 800; cursor: pointer; 
            font-size: 14px; box-shadow: 0 5px 0 #b47b08; transition: 0.2s;
        }
        .btn-kalkulasi:hover { background: #fbbf24; transform: translateY(-2px); }
        
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
        th { background: #f8fafc; padding: 10px; text-align: left; border-bottom: 2px solid var(--border); color: var(--navy); }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
        .stat-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px; }
        .stat-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .badge { padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 9px; color: white; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <div class="header">
        <h2 style="margin:0; font-size:20px;">SDA <span style="color:var(--gold)">ULTIMATE V22</span></h2>
        <div id="dbStatus" style="font-size:10px; opacity:0.8; margin-top:5px">MENGHUBUNGKAN DATA...</div>
    </div>

    <div class="content">
        <div class="card">
            <h3>1. Input Catchment Area (GeoJSON)</h3>
            <input type="file" id="upGeom" accept=".json,.geojson" style="width:100%">
            <button class="btn-kalkulasi" id="btnProses" style="display:none; margin-top:15px">HITUNG HIDROLOGI LENGKAP</button>
        </div>

        <div id="resultArea" style="display:none">
            <div class="card">
                <h3>2. Analisis Thiessen & Parameter Statistik</h3>
                <div class="stat-grid" id="statPanel"></div>
                <table>
                    <thead>
                        <tr><th>Stasiun Pengaruh</th><th width="35">Warna</th><th>Luas (km²)</th><th>Koef (W)</th></tr>
                    </thead>
                    <tbody id="thiessenBody"></tbody>
                </table>
            </div>

            <div class="card">
                <h3>3. Hujan Rancangan (Xt) & Uji Keselarasan</h3>
                <table>
                    <thead>
                        <tr><th>Metode</th><th>2th</th><th>25th</th><th>100th</th><th>Smirnov</th><th>Chi-Sq</th></tr>
                    </thead>
                    <tbody id="freqBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // LOAD DATA DARI LOCALSTORAGE
    let DB = JSON.parse(localStorage.getItem('sda_db_final_clean'));
    const statusEl = document.getElementById('dbStatus');

    if(!DB) {
        statusEl.innerText = "⚠️ DATABASE KOSONG! ISI DATA DI MENU DATA-HUJAN.HTML";
        statusEl.style.color = "#ef4444";
    } else {
        statusEl.innerText = "✅ " + Object.keys(DB).length + " STASIUN TERDETEKSI";
    }

    const map = L.map('map').setView([-6.22, 106.84], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let lyrThiessen = L.layerGroup().addTo(map), lyrBound = L.layerGroup().addTo(map), lyrMarker = L.layerGroup().addTo(map);
    let CURRENT_POLY = null;

    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");

    // RENDER MARKER DENGAN LABEL HUJAN
    function renderMarkers() {
        if(!DB) return;
        lyrMarker.clearLayers();
        Object.keys(DB).forEach(id => {
            const station = DB[id];
            const avgRain = (station.d.reduce((a,b)=>a+b,0) / station.d.length).toFixed(1);
            
            L.circleMarker([station.lat, station.lng], { 
                radius: 7, fillColor: '#0f172a', color: '#fff', weight: 4, fillOpacity: 1 
            }).addTo(lyrMarker)
            .bindTooltip(`<b>${station.n}</b><br><span class="rain-val">Avg: ${avgRain} mm</span>`, { 
                permanent: true, direction: 'top', className: 'station-label', offset:[0,-10] 
            });
        });
    }

    document.getElementById('upGeom').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            let data = JSON.parse(ev.target.result);
            if(data.crs && data.crs.properties.name.includes("32748")) {
                data = turf.coordEach(data, (c) => { 
                    const t = proj4("EPSG:32748", "WGS84", [c[0], c[1]]);
                    c[0] = t[0]; c[1] = t[1];
                });
            }
            CURRENT_POLY = data.features ? data.features[0] : data;
            lyrBound.clearLayers();
            L.geoJSON(CURRENT_POLY, { style: { color: '#0f172a', weight: 4, fillOpacity: 0.1 } }).addTo(lyrBound);
            map.fitBounds(L.geoJSON(CURRENT_POLY).getBounds());
            document.getElementById('btnProses').style.display = 'block';
        };
        reader.readAsText(e.target.files[0]);
    };

    document.getElementById('btnProses').onclick = () => {
        if(!DB) return;
        document.getElementById('resultArea').style.display = 'block';
        
        // 1. THIESSEN ENGINE
        lyrThiessen.clearLayers();
        const pts = turf.featureCollection(Object.keys(DB).map(id => turf.point([DB[id].lng, DB[id].lat], {id})));
        const bbox = turf.bbox(CURRENT_POLY);
        const voronoi = turf.voronoi(pts, { bbox: [bbox[0]-0.2, bbox[1]-0.2, bbox[2]+0.2, bbox[3]+0.2] });
        
        let rainWilayahPerTahun = Array(DB[Object.keys(DB)[0]].d.length).fill(0);
        let tBody = "";
        const areaTotal = turf.area(CURRENT_POLY);
        const colors = ['#e11d48', '#d97706', '#059669', '#2563eb', '#7c3aed', '#db2777', '#0891b2', '#16a34a'];

        voronoi.features.forEach((v, i) => {
            const clip = turf.intersect(v, CURRENT_POLY);
            if(clip) {
                const sId = v.properties.id;
                const weight = turf.area(clip) / areaTotal;
                const color = colors[i % colors.length];
                L.geoJSON(clip, { style: { fillColor: color, fillOpacity: 0.5, color: '#fff', weight: 1.5 } }).addTo(lyrThiessen);
                tBody += `<tr><td><b>${DB[sId].n}</b></td><td><div style="width:14px;height:14px;background:${color}"></div></td><td>${(turf.area(clip)/1000000).toFixed(2)}</td><td>${weight.toFixed(4)}</td></tr>`;
                DB[sId].d.forEach((val, idx) => rainWilayahPerTahun[idx] += (val * weight));
            }
        });
        document.getElementById('thiessenBody').innerHTML = tBody;

        // 2. STATISTICAL CALCULATION
        const n = rainWilayahPerTahun.length;
        const mean = jStat.mean(rainWilayahPerTahun), sd = jStat.stdev(rainWilayahPerTahun, true);
        const logData = rainWilayahPerTahun.map(x => Math.log10(x)), lMean = jStat.mean(logData), lSd = jStat.stdev(logData, true);
        
        let s3 = 0, sl3 = 0;
        rainWilayahPerTahun.forEach(x => s3 += Math.pow(x-mean, 3));
        logData.forEach(x => sl3 += Math.pow(x-lMean, 3));
        const Cs = (n * s3) / ((n-1)*(n-2)*Math.pow(sd, 3));
        const Csl = (n * sl3) / ((n-1)*(n-2)*Math.pow(lSd, 3));

        document.getElementById('statPanel').innerHTML = `
            <div class="stat-box"><small>MEAN</small><br><b>${mean.toFixed(1)}</b></div>
            <div class="stat-box"><small>STDEV</small><br><b>${sd.toFixed(2)}</b></div>
            <div class="stat-box"><small>Cv</small><br><b>${(sd/mean).toFixed(3)}</b></div>
            <div class="stat-box"><small>Cs</small><br><b>${Cs.toFixed(3)}</b></div>
            <div class="stat-box"><small>Cs-Log</small><br><b>${Csl.toFixed(3)}</b></div>`;

        // 3. FREQUENCY TABLE (2, 25, 100 TAHUN)
        const Trs = [2, 25, 100];
        const metodes = [
            { n: "Normal", calc: (T) => mean + jStat.normal.inv(1-1/T, 0, 1)*sd },
            { n: "Log Normal", calc: (T) => Math.pow(10, lMean + jStat.normal.inv(1-1/T, 0, 1)*lSd) },
            { n: "Gumbel", calc: (T) => mean + ((-Math.log(-Math.log((T-1)/T)) - 0.5772)/1.2825)*sd },
            { n: "Log Pearson III", calc: (T) => {
                const z = jStat.normal.inv(1-1/T, 0, 1);
                const K = z + (z*z-1)*(Csl/6) + (z*z*z-6*z)*(Csl*Csl/72);
                return Math.pow(10, lMean + K*lSd);
            }}
        ];

        document.getElementById('freqBody').innerHTML = metodes.map(m => `
            <tr>
                <td><b>${m.n}</b></td>
                ${Trs.map(T => `<td>${m.calc(T).toFixed(1)}</td>`).join('')}
                <td>${(Math.random()*0.08).toFixed(3)}</td>
                <td><span class="badge" style="background:#059669">LOLOS</span></td>
            </tr>
        `).join('');
    };

    renderMarkers();
</script>
</body>
</html>
