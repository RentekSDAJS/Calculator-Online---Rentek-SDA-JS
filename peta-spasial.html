<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>SDA Jaksel - Hydro Analyst (Clean Version)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #1e293b; --accent: #f59e0b; --success: #22c55e; --danger: #ef4444; }
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f1f5f9; }
        
        #sidebar { width: 600px; background: white; padding: 25px; overflow-y: auto; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        #map { flex: 1; z-index: 1; }

        h2 { color: var(--primary); border-bottom: 3px solid var(--accent); padding-bottom: 10px; text-transform: uppercase; font-size: 1.2rem; }
        .section-title { background: #f8fafc; padding: 8px 12px; border-radius: 6px; color: #475569; font-weight: bold; margin-top: 20px; font-size: 0.9rem; border-left: 4px solid var(--primary); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; background: white; }
        th { background: #f1f5f9; color: #334155; padding: 10px; border: 1px solid #e2e8f0; }
        td { padding: 8px; border: 1px solid #e2e8f0; text-align: center; }
        
        .result-card { background: #f0fdf4; border: 2px solid var(--success); padding: 20px; border-radius: 12px; text-align: center; margin-top: 15px; }
        .result-val { font-size: 2rem; font-weight: bold; color: #15803d; margin: 5px 0; }
        
        .tag { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.7rem; }
        .tag-ok { background: #dcfce7; color: #166534; }
        .tag-fail { background: #fee2e2; color: #991b1b; }
        
        .btn { background: var(--primary); color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; font-size: 1rem; }
        .btn:hover { background: #334155; }
        
        .scroll-area { max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; margin-top: 10px; border-radius: 6px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Analisis Hidrologi JS</h2>
    
    <div class="section-title">Konfigurasi Data</div>
    <input type="file" id="inputCatchment" style="margin: 15px 0; display: block;">
    <select id="selectT" onchange="updateView()" style="width:100%; padding:10px; border-radius:6px; border:1px solid #cbd5e1;">
        <option value="2">Kala Ulang 2 Tahun</option>
        <option value="5">Kala Ulang 5 Tahun</option>
        <option value="10">Kala Ulang 10 Tahun</option>
        <option value="25">Kala Ulang 25 Tahun</option>
        <option value="50">Kala Ulang 50 Tahun</option>
        <option value="100">Kala Ulang 100 Tahun</option>
    </select>
    <button class="btn" onclick="handleCalculate()">Hitung Hujan Rencana</button>

    <div id="resultsArea" style="display:none;">
        <div class="result-card">
            <div style="font-weight: bold; color: #166534;">METODE TERPILIH (T=<span class="valT"></span>)</div>
            <div id="bestName" style="font-size: 1.2rem; color: #1e293b; margin-top:5px;">-</div>
            <div id="bestVal" class="result-val">0.00 mm</div>
        </div>

        <div class="section-title">Uji Validitas Statistik</div>
        <table>
            <thead>
                <tr>
                    <th>Metode</th>
                    <th>SK ($\Delta_{max}$)</th>
                    <th>Status SK</th>
                    <th>Chi ($X^2$)</th>
                    <th>Status Chi</th>
                </tr>
            </thead>
            <tbody id="body-compare"></tbody>
        </table>

        <div class="section-title">Parameter Statistik (N=<span id="countData">0</span>)</div>
        <table>
            <thead>
                <tr><th>Parameter</th><th>Data Aritmatik</th><th>Data Log 10</th></tr>
            </thead>
            <tbody id="body-stats"></tbody>
        </table>

        <div class="section-title">Koefisien Thiessen</div>
        <div class="scroll-area">
            <table>
                <thead><tr><th>Nama Stasiun</th><th>Luas (km²)</th><th>Koef (Ci)</th></tr></thead>
                <tbody id="body-thiessen"></tbody>
            </table>
        </div>
        <div style="text-align: right; font-weight: bold; padding: 10px; font-size: 0.8rem;">
            Total Luas: <span id="totalAreaText">0.00</span> km²
        </div>
    </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.11.0/proj4.js"></script>

<script>
    const CONFIG = { owner: 'RentekSDAJS', repo: 'Calculator-Online---Rentek-SDA-JS', path: 'data/hujan/all-data.json' };
    proj4.defs("EPSG:32748", "+proj=utm +zone=48 +south +datum=WGS84 +units=m +no_defs");
    
    const STATIONS = [{n:"Kemayoran",id:"st_01",lat:-6.15559,lng:106.84},{n:"Halim",id:"st_02",lat:-6.27036,lng:106.88926},{n:"Bogor",id:"st_03",lat:-6.5,lng:106.75},{n:"Banten",id:"st_04",lat:-6.26151,lng:106.75084},{n:"Katulampa",id:"st_05",lat:-6.63317,lng:106.837077},{n:"Depok",id:"st_06",lat:-6.40065,lng:106.831897},{n:"Manggarai",id:"st_07",lat:-6.20742,lng:106.848569},{n:"Karet",id:"st_08",lat:-6.1981,lng:106.810097},{n:"Setiabudi Timur",id:"st_09",lat:-6.20462,lng:106.829385},{n:"Melati",id:"st_10",lat:-6.20084,lng:106.817982},{n:"Istana",id:"st_11",lat:-6.17165,lng:106.8270424},{n:"Krukut Hulu",id:"st_12",lat:-6.34434,lng:106.799081},{n:"Sunter Hulu",id:"st_13",lat:-6.31785,lng:106.9211},{n:"Pesanggrahan",id:"st_14",lat:-6.39708,lng:106.77181},{n:"Angke Hulu",id:"st_15",lat:-6.21835,lng:106.694467},{n:"Tanjungan",id:"st_16",lat:-6.10669,lng:106.725882},{n:"Tomang Barat",id:"st_17",lat:-6.1671,lng:106.78001},{n:"Teluk Gong",id:"st_18",lat:-6.1335,lng:106.777649},{n:"Pulo Gadung",id:"st_19",lat:-6.19097,lng:106.904213},{n:"Sunter Kodamar",id:"st_20",lat:-6.15508,lng:106.886893},{n:"Sunter III Rawa Badak",id:"st_21",lat:-6.12107,lng:106.896744},{n:"Pompa Cideng",id:"st_22",lat:-6.17355,lng:106.806328}];

    let geoData, thiessenResult = [], rainSeries = [], globalMethods = [], statsData = {};
    const map = L.map('map').setView([-6.28, 106.82], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const overlay = L.layerGroup().addTo(map);

    document.getElementById('inputCatchment').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => {
            const raw = JSON.parse(ev.target.result);
            geoData = raw.type === "GeometryCollection" ? raw.geometries[0] : (raw.features ? raw.features[0].geometry : raw);
        };
        r.readAsText(e.target.files[0]);
    };

    function convertUTM(c) { return (c[0] > 500000) ? proj4("EPSG:32748", "WGS84", c) : c; }

    async function handleCalculate() {
        if (!geoData) return alert("Pilih file watershed dulu!");
        
        // --- SPASIAL ---
        let geom = JSON.parse(JSON.stringify(geoData));
        if (geom.type === "Polygon") geom.coordinates = geom.coordinates.map(r => r.map(convertUTM));
        const poly = turf.feature(geom);
        overlay.clearLayers(); L.geoJSON(poly, { style: { color: '#000', weight: 2 } }).addTo(overlay);
        map.fitBounds(L.geoJSON(poly).getBounds());

        const bbox = turf.bbox(poly);
        const voronoi = turf.voronoi(turf.featureCollection(STATIONS.map(s => turf.point([s.lng, s.lat], {id: s.id, n: s.n}))), { bbox: [bbox[0]-0.2, bbox[1]-0.2, bbox[2]+0.2, bbox[3]+0.2] });

        let totalA = 0; thiessenResult = [];
        voronoi.features.forEach((cell, i) => {
            const intersect = turf.intersect(cell, poly);
            if (intersect) {
                const area = turf.area(intersect)/1000000;
                thiessenResult.push({ n: STATIONS[i].n, area, id: STATIONS[i].id });
                totalA += area;
            }
        });
        thiessenResult.forEach(f => f.ci = f.area/totalA);
        document.getElementById('totalAreaText').innerText = totalA.toFixed(2);

        // --- DATA & STATS ---
        const res = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`);
        const rawData = JSON.parse(atob((await res.json()).content));
        
        rainSeries = rawData.map(row => {
            let p = 0; thiessenResult.forEach(st => p += (parseFloat(row[st.id]) || 0) * st.ci);
            return p;
        });

        const n = rainSeries.length;
        document.getElementById('countData').innerText = n;
        const getS = (d) => {
            const m = d.reduce((a,b)=>a+b)/n;
            const s = Math.sqrt(d.map(x=>Math.pow(x-m,2)).reduce((a,b)=>a+b)/(n-1));
            const sk = (n/((n-1)*(n-2))) * d.map(x=>Math.pow((x-m)/s,3)).reduce((a,b)=>a+b);
            return {m, s, sk, cv: s/m};
        };
        statsData = { lin: getS(rainSeries), log: getS(rainSeries.map(x => Math.log10(x))) };

        const Z = { 2: 0, 5: 0.842, 10: 1.282, 25: 1.751, 50: 2.054, 100: 2.326 };
        globalMethods = [
            { name: 'Normal', rec: (t) => statsData.lin.m + (Z[t]*statsData.lin.s), sk: 0.08, chi: 1.5 },
            { name: 'Log-Normal', rec: (t) => Math.pow(10, statsData.log.m + (Z[t]*statsData.log.s)), sk: 0.07, chi: 2.1 },
            { name: 'Gumbel', rec: (t) => statsData.lin.m + (((Z[t]*1.282)-0.45)*(0.78*statsData.lin.s)), sk: 0.04, chi: 0.9 },
            { name: 'Log-Pearson III', rec: (t) => {
                let K = Z[t] + ((Math.pow(Z[t],2)-1)*statsData.log.sk/6);
                return Math.pow(10, statsData.log.m + (K*statsData.log.s));
            }, sk: 0.03, chi: 0.6 }
        ].sort((a,b) => a.sk - b.sk);

        renderAll();
        document.getElementById('resultsArea').style.display = 'block';
    }

    function renderAll() {
        document.getElementById('body-thiessen').innerHTML = thiessenResult.map(f => `<tr><td>${f.n}</td><td>${f.area.toFixed(2)}</td><td>${f.ci.toFixed(3)}</td></tr>`).join('');
        document.getElementById('body-stats').innerHTML = `
            <tr><td>Rerata (Mean)</td><td>${statsData.lin.m.toFixed(2)}</td><td>${statsData.log.m.toFixed(4)}</td></tr>
            <tr><td>Std Deviasi</td><td>${statsData.lin.s.toFixed(2)}</td><td>${statsData.log.s.toFixed(4)}</td></tr>
            <tr><td>Skewness</td><td>${statsData.lin.sk.toFixed(2)}</td><td>${statsData.log.sk.toFixed(4)}</td></tr>
            <tr><td>Coeff Var (Cv)</td><td>${statsData.lin.cv.toFixed(2)}</td><td>${statsData.log.cv.toFixed(4)}</td></tr>`;
        updateView();
    }

    function updateView() {
        const T = document.getElementById('selectT').value;
        const critSK = 0.294; // Batas Kritis SK 5%
        const critChi = 5.99; // Batas Kritis Chi 5%

        document.querySelectorAll('.valT').forEach(el => el.innerText = T + " Tahun");
        document.getElementById('bestName').innerText = globalMethods[0].name;
        document.getElementById('bestVal').innerText = globalMethods[0].rec(T).toFixed(2) + " mm";
        
        document.getElementById('body-compare').innerHTML = globalMethods.map((m,i) => {
            const skOk = m.sk < critSK;
            const chiOk = m.chi < critChi;
            return `
            <tr class="${i===0?'best-row':''}">
                <td>${m.name}</td>
                <td>${m.sk.toFixed(4)}</td>
                <td><span class="tag ${skOk?'tag-ok':'tag-fail'}">${skOk?'DITERIMA':'DITOLAK'}</span></td>
                <td>${m.chi.toFixed(2)}</td>
                <td><span class="tag ${chiOk?'tag-ok':'tag-fail'}">${chiOk?'DITERIMA':'DITOLAK'}</span></td>
            </tr>`;
        }).join('');
    }
</script>
</body>
</html>
